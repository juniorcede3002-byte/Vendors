<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
  authDomain: "proyectovendor.firebaseapp.com",
  projectId: "proyectovendor"
});
const db = firebase.firestore();
const CLOUD_NAME="df79cjklp";
const UPLOAD_PRESET="vendors_preset";

/* ELEMENTOS */
const roleSelect = document.getElementById("role");
const productsList = document.getElementById("productsList");
const adminPanel = document.getElementById("adminPanel");
const nameInput = document.getElementById("name");
const descriptionInput = document.getElementById("description");
const priceInput = document.getElementById("price");
const mediaInput = document.getElementById("media");
const cartListDiv = document.getElementById("cartList");
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modalBody");
const ordersListDiv = document.getElementById("ordersList");
const purchaseHistoryDiv = document.getElementById("purchaseHistory");

/* CARRITO EN LOCALSTORAGE */
let cart = JSON.parse(localStorage.getItem("cart")) || [];

/* TOGGLE ADMIN */
function toggleAdminFeatures(){
    adminPanel.style.display = roleSelect.value==="admin"?"block":"none";
}

document.addEventListener("DOMContentLoaded",()=>{
    toggleAdminFeatures();
    loadProducts();
    loadOrders();
    loadUserOrders();
});

/* SUBIR PRODUCTO */
async function uploadProduct(){
  const file = mediaInput.files[0];
  if(!file) return alert("Archivo requerido");
  if(!nameInput.value.trim() || !priceInput.value) return alert("Nombre y precio obligatorios");

  const form=new FormData();
  form.append("file",file);
  form.append("upload_preset",UPLOAD_PRESET);

  const isVideo=file.type.startsWith("video");
  const endpoint=isVideo?"video":"image";

  const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${endpoint}/upload`,{method:"POST",body:form});
  const data=await res.json();
  if(!data.secure_url) return alert("Error subir archivo");

  await db.collection("products").add({
    name:nameInput.value.trim(),
    description:descriptionInput.value.trim(),
    price:Number(priceInput.value),
    mediaUrl:data.secure_url,
    mediaType:isVideo?"video":"image",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Producto subido");
  nameInput.value=""; descriptionInput.value=""; priceInput.value=""; mediaInput.value="";
}

/* LISTAR PRODUCTOS */
function loadProducts(){
  const role = roleSelect.value;
  const search = document.getElementById("search").value.toLowerCase();
  const maxPrice = document.getElementById("maxPrice").value;

  db.collection("products").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    productsList.innerHTML="";
    snapshot.forEach(doc=>{
      const p = doc.data();
      if((search && !p.name.toLowerCase().includes(search)) || (maxPrice && p.price>maxPrice)) return;

      productsList.innerHTML+=`
        <div class="product">
          ${p.mediaType==="video"?`<video src="${p.mediaUrl}" controls></video>`:`<img src="${p.mediaUrl}">`}
          <h3>${p.name}</h3>
          <p>${p.description}</p>
          <b>$${p.price}</b>
          <div class="actions">
            <button onclick="showContact('${p.name}')"><i class="fa fa-phone"></i> Contactar</button>
            <button onclick="addToCart('${doc.id}','${p.name}',${p.price})"><i class="fa fa-cart-plus"></i> Añadir al carrito</button>
            ${role==="admin"?`
              <button onclick="editProduct('${doc.id}','${p.name}','${p.description}',${p.price})"><i class="fa fa-edit"></i> Editar</button>
              <button onclick="deleteProduct('${doc.id}')"><i class="fa fa-trash"></i> Eliminar</button>`:""}
          </div>
        </div>
      `;
    });
  });
}

/* EDITAR / ELIMINAR PRODUCTO */
function editProduct(id,name,desc,price){
  const newName = prompt("Nombre:",name);
  const newDesc = prompt("Descripción:",desc);
  const newPrice = prompt("Precio:",price);
  if(newName && newDesc && newPrice){
    db.collection("products").doc(id).update({
      name:newName,
      description:newDesc,
      price:Number(newPrice)
    });
    alert("Producto actualizado");
  }
}

function deleteProduct(id){
  if(confirm("¿Eliminar producto?")) db.collection("products").doc(id).delete();
}

/* CONTACTAR */
function showContact(name){
  openModal(`Contacta al vendedor sobre: <b>${name}</b><br>Número: 63892022`);
}

/* CARRITO */
function addToCart(id,name,price){
  cart.push({id,name,price});
  localStorage.setItem("cart",JSON.stringify(cart));
  showModalMessage(`${name} añadido al carrito`);
}

function emptyCart(){
  if(confirm("Vaciar carrito?")){
    cart=[];
    localStorage.setItem("cart",JSON.stringify(cart));
    cartListDiv.innerHTML="<i>Carrito vacío</i>";
  }
}

function viewCart(){
  if(cart.length===0){ cartListDiv.innerHTML="<i>Carrito vacío</i>"; return; }
  let html="<ul>";
  let total=0;
  cart.forEach(item=>{ html+=`<li>${item.name} - $${item.price}</li>`; total+=item.price; });
  html+=`</ul><b>Total: $${total}</b>`;
  cartListDiv.innerHTML=html;
}

/* MODAL */
function openModal(content){ modal.style.display="flex"; modalBody.innerHTML=content; }
function closeModal(){ modal.style.display="none"; }
function showModalMessage(msg){ openModal(`<p>${msg}</p>`); setTimeout(closeModal,1500); }

/* FORMULARIO DE COMPRA */
function openPurchaseForm(){
  if(cart.length===0){ alert("Carrito vacío"); return; }
  let html=`<h3>Formulario de Compra</h3>
    <input id="buyerName" placeholder="Nombre">
    <input id="buyerPhone" placeholder="Teléfono/WhatsApp">
    <input id="buyerAddress" placeholder="Dirección de entrega">
    <input id="buyerEmail" placeholder="Email">
    <label>Adjuntar comprobante (opcional)</label>
    <input type="file" id="paymentProof" accept="image/*">
    <button onclick="confirmPurchase()">Confirmar Compra</button>`;
  openModal(html);
}

/* CONFIRMAR COMPRA */
async function confirmPurchase(){
  const name = document.getElementById("buyerName").value.trim();
  const phone = document.getElementById("buyerPhone").value.trim();
  const address = document.getElementById("buyerAddress").value.trim();
  const email = document.getElementById("buyerEmail").value.trim();
  const proofFile = document.getElementById("paymentProof").files[0];

  if(!name || !phone || !address || !email) return alert("Todos los campos son obligatorios");

  let proofUrl="";
  if(proofFile){
    const form=new FormData();
    form.append("file",proofFile);
    form.append("upload_preset",UPLOAD_PRESET);
    const isVideo=false;
    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:"POST",body:form});
    const data=await res.json();
    proofUrl=data.secure_url;
  }

  await db.collection("orders").add({
    buyerName:name,
    buyerPhone:phone,
    buyerAddress:address,
    buyerEmail:email,
    products:cart,
    status:"pendiente",
    proof:proofUrl || "",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  cart=[]; localStorage.setItem("cart",JSON.stringify(cart)); closeModal();
  showModalMessage("Compra enviada correctamente");
  loadOrders(); loadUserOrders();
}

/* CARGAR ORDENES ADMIN */
function loadOrders(){
  if(roleSelect.value!=="admin"){ ordersListDiv.innerHTML="<i>No tienes acceso</i>"; return; }
  db.collection("orders").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    ordersListDiv.innerHTML="";
    snapshot.forEach(doc=>{
      const o=doc.data();
      const statusClass=getStatusClass(o.status);
      let proofBtn=o.proof?`<button onclick="viewProof('${o.proof}')">Ver comprobante</button>`:"";
      ordersListDiv.innerHTML+=`
        <div class="product">
          <h4>${o.buyerName} - ${o.buyerPhone}</h4>
          <p>${o.buyerAddress} - ${o.buyerEmail}</p>
          <b>${o.products.map(p=>p.name+" $"+p.price).join(", ")}</b>
          <p class="${statusClass}">Estado: ${o.status}</p>
          ${proofBtn}
          <button onclick="updateStatus('${doc.id}')">Cambiar Estado</button>
          <button onclick="cancelOrder('${doc.id}')">Cancelar Compra</button>
        </div>
      `;
    });
  });
}

/* CARGAR ORDENES USUARIO */
function loadUserOrders(){
  db.collection("orders").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    purchaseHistoryDiv.innerHTML="";
    snapshot.forEach(doc=>{
      const o=doc.data();
      const statusClass=getStatusClass(o.status);
      purchaseHistoryDiv.innerHTML+=`
        <div class="product">
          <b>${o.products.map(p=>p.name+" $"+p.price).join(", ")}</b>
          <p class="${statusClass}">Estado: ${o.status}</p>
          ${o.proof?`<button onclick="viewProof('${o.proof}')">Ver comprobante</button>`:""}
        </div>
      `;
    });
  });
}

/* CAMBIAR ESTADO */
function updateStatus(id){
  const next = prompt("Nuevo estado (revision, verificado, en-camino, finalizado):");
  if(next && ["revision","verificado","en-camino","finalizado"].includes(next)){
    db.collection("orders").doc(id).update({status:next});
  }
}

/* CANCELAR ORDEN */
function cancelOrder(id){
  const reason=prompt("Motivo de cancelación:");
  if(reason){
    db.collection("orders").doc(id).update({status:"cancelada",cancelReason:reason});
  }
}

/* VER COMPROBANTE */
function viewProof(url){
  openModal(`<img src="${url}" style="width:100%"/>`);
}

/* STATUS CLASS */
function getStatusClass(status){
  switch(status){
    case "pendiente": return "status-pendiente";
    case "revision": return "status-revision";
    case "verificado": return "status-verificado";
    case "en-camino": return "status-en-camino";
    case "finalizado": return "status-finalizado";
    case "cancelada": return "status-cancelada";
    default: return "";
}
}
</script>
