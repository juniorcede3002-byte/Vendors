<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Vendor | Dashboard Final Integrado</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

<style>
body { font-family: Arial,sans-serif; background:#f2f2f2; margin:0; padding:0; }
header { background:#111; color:#fff; padding:15px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:999; }
header button { background:#fff; color:#111; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; }
.container { max-width:1000px; margin:auto; padding:20px; display:none; }
.tabs { display:flex; gap:5px; margin-bottom:15px; flex-wrap:wrap; }
.tabs button { flex:1; padding:10px; cursor:pointer; border:none; border-radius:5px; background:#ddd; transition:0.2s; }
.tabs button.active { background:#111; color:#fff; }
.tab-content { display:none; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.tab-content.active { display:block; }
input, textarea, select, button { width:100%; padding:10px; margin-top:10px; border-radius:5px; border:1px solid #ccc; }
button { background:#111; color:#fff; border:none; cursor:pointer; transition:0.2s; }
button:hover { opacity:0.9; }
.product, .order { border:1px solid #ddd; padding:10px; margin-top:15px; border-radius:8px; background:#fafafa; }
.actions { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }
.actions button { flex:1; display:flex; align-items:center; justify-content:center; gap:5px; }
.status-pendiente { color:#ff9800; font-weight:bold; }
.status-revision { color:#2196f3; font-weight:bold; }
.status-verificado { color:#4caf50; font-weight:bold; }
.status-en-camino { color:#9c27b0; font-weight:bold; }
.status-finalizado { color:#000; font-weight:bold; }
.status-cancelada { color:#f44336; font-weight:bold; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;}
.modal-content { background:#fff; padding:20px; border-radius:8px; max-width:500px; width:90%; position:relative; box-shadow:0 2px 15px rgba(0,0,0,0.3); }
.modal-content button.close { position:absolute; top:10px; right:10px; background:#f00; border:none; border-radius:50%; width:30px; height:30px; color:#fff; cursor:pointer; font-weight:bold; font-size:16px; }
img.product-img, video.product-video { max-width:150px; max-height:150px; margin-top:5px; border-radius:5px; }
</style>
</head>
<body>

<header>
  Vendor Dashboard
  <div id="authButtons">
    <button onclick="showLoginForm()">Iniciar Sesión</button>
    <button onclick="showRegisterForm()">Crear Cuenta</button>
    <button onclick="loginWithGoogle()">Google</button>
  </div>
  <div id="userInfo" style="display:none;">
    <span id="userEmail"></span>
    <button onclick="logout()">Cerrar Sesión</button>
    <button onclick="openConfig()">Configuración</button>
  </div>
</header>

<div class="container" id="dashboard">
  <div class="tabs">
    <button class="tab-btn active" data-tab="productsTab">Productos</button>
    <button class="tab-btn" data-tab="cartTab">Carrito</button>
    <button class="tab-btn" data-tab="ordersTab">Compras</button>
    <button class="tab-btn" data-tab="adminTab">Admin</button>
  </div>

  <div id="productsTab" class="tab-content active">
    <h2>Productos</h2>
    <input id="search" placeholder="Buscar por nombre" oninput="filterProducts()">
    <input id="maxPrice" type="number" placeholder="Precio máximo" oninput="filterProducts()">
    <div id="productsList"></div>
  </div>

  <div id="cartTab" class="tab-content">
    <h2>Carrito</h2>
    <div id="cartList"><i>Carrito vacío</i></div>
    <button onclick="viewCart()">Ver Carrito</button>
    <button onclick="openPurchaseForm()">Comprar Carrito</button>
    <button onclick="emptyCart()">Vaciar Carrito</button>
  </div>

  <div id="ordersTab" class="tab-content">
    <h2>Historial de Compras</h2>
    <div id="purchaseHistory"></div>
  </div>

  <div id="adminTab" class="tab-content">
    <div id="adminPanel">
      <h3>Subir Producto</h3>
      <input id="name" placeholder="Nombre">
      <textarea id="description" placeholder="Descripción"></textarea>
      <input id="price" type="number" placeholder="Precio">
      <input id="media" type="file" accept="image/*,video/*">
      <button onclick="uploadProduct()">Subir</button>

      <h3>Solicitudes de Compra</h3>
      <div id="ordersList"></div>
    </div>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <button class="close" onclick="closeModal()">&times;</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
  authDomain: "proyectovendor.firebaseapp.com",
  projectId: "proyectovendor"
});
const db = firebase.firestore();
const auth = firebase.auth();

let cart = JSON.parse(localStorage.getItem("cart")) || [];
let role = "usuario";

// --- Modal ---
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modalBody");
function openModal(content){ modal.style.display="flex"; modalBody.innerHTML=content; }
function closeModal(){ modal.style.display="none"; }
function showModalMessage(msg){ openModal(`<p>${msg}</p>`); setTimeout(closeModal,1500); }

// --- Auth ---
function showLoginForm(){
  openModal(`<h3>Iniciar Sesión</h3>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPass" placeholder="Contraseña" type="password">
  <button onclick="login()">Entrar</button>
  <button onclick="showResetPass()">Olvidé mi contraseña</button>
  <button onclick="loginWithGoogle()">Google</button>`);
}
function showRegisterForm(){
  openModal(`<h3>Crear Cuenta</h3>
  <input id="regEmail" placeholder="Email">
  <input id="regPass" placeholder="Contraseña" type="password">
  <button onclick="register()">Registrar</button>`);
}
function showResetPass(){
  const email = prompt("Ingrese su correo para recuperar contraseña:");
  if(email) auth.sendPasswordResetEmail(email).then(()=>alert("Correo enviado")).catch(e=>alert(e.message));
}
function login(){
  const email=document.getElementById("loginEmail").value;
  const pass=document.getElementById("loginPass").value;
  auth.signInWithEmailAndPassword(email,pass).then(u=>{ closeModal(); initUser(u.user); }).catch(e=>alert(e.message));
}
function register(){
  const email=document.getElementById("regEmail").value;
  const pass=document.getElementById("regPass").value;
  auth.createUserWithEmailAndPassword(email,pass).then(u=>{ closeModal(); initUser(u.user); }).catch(e=>alert(e.message));
}
function logout(){ auth.signOut().then(()=>location.reload()); }

// --- Google Auth ---
function loginWithGoogle(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
  .then(result => initUser(result.user))
  .catch(e=>alert(e.message));
}

function initUser(user){
  document.getElementById("authButtons").style.display="none";
  document.getElementById("userInfo").style.display="inline-block";
  document.getElementById("userEmail").innerText=user.email;
  role = (user.email==="admin@vendors.com") ? "admin" : "usuario";
  document.getElementById("dashboard").style.display="block";
  toggleAdmin();
  setUpTabs();
  loadProducts();
  loadOrders();
  loadUserOrders();
  renderCart();
}

// --- Configuración ---
function openConfig(){
  const user = auth.currentUser;
  openModal(`<h3>Configuración</h3>
    <input id="configName" placeholder="Nombre" value="${user.displayName||''}">
    <input id="configEmail" placeholder="Email" value="${user.email}">
    <input id="configCountry" placeholder="País">
    <input id="configResidence" placeholder="Residencia">
    <input id="configPass" placeholder="Nueva contraseña" type="password">
    <button onclick="updateConfig()">Guardar</button>`);
}
function updateConfig(){
  const name=document.getElementById("configName").value;
  const email=document.getElementById("configEmail").value;
  const pass=document.getElementById("configPass").value;
  const user = auth.currentUser;
  if(name) user.updateProfile({displayName:name});
  if(email) user.updateEmail(email).catch(e=>alert(e.message));
  if(pass) user.updatePassword(pass).catch(e=>alert(e.message));
  showModalMessage("Configuración actualizada");
  closeModal();
}

// --- Tabs ---
function setUpTabs(){
  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      document.querySelectorAll(".tab-content").forEach(tab=>tab.classList.remove("active"));
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });
}
function toggleAdmin(){ 
  if(role==="admin"){ document.getElementById("adminPanel").style.display="block"; document.querySelector("[data-tab='adminTab']").style.display="inline-block"; }
  else { document.getElementById("adminPanel").style.display="none"; document.querySelector("[data-tab='adminTab']").style.display="none"; }
}

// --- Productos ---
async function loadProducts(){
  const productsList = document.getElementById("productsList");
  productsList.innerHTML = "Cargando...";
  db.collection("products").onSnapshot(snapshot=>{
    let html="";
    snapshot.forEach(doc=>{
      const p = doc.data();
      let mediaHtml = '';
      if(p.media){
        if(p.media.match(/\.(mp4|webm)$/)) mediaHtml = `<video class="product-video" src="${p.media}" controls></video>`;
        else mediaHtml = `<img class="product-img" src="${p.media}">`;
      }
      html+=`
      <div class="product">
        <strong>${p.name}</strong> - $${p.price} <br>
        ${p.description}<br>
        ${mediaHtml}
        <div class="actions">
          <button onclick="addToCart('${doc.id}','${p.name}',${p.price},'${p.media||''}')"><i class="fa fa-cart-plus"></i> Añadir al carrito</button>
          ${role==='admin'?`<button onclick="editProduct('${doc.id}','${p.name}','${p.description}',${p.price})"><i class="fa fa-edit"></i> Editar</button>
          <button onclick="deleteProduct('${doc.id}')"><i class="fa fa-trash"></i> Eliminar</button>`:''}
        </div>
      </div>`;
    });
    productsList.innerHTML = html || "<i>No hay productos</i>";
  }, err=>console.log(err));
}

// --- Cloudinary Upload ---
async function uploadProduct(){
  const name=document.getElementById("name").value.trim();
  const desc=document.getElementById("description").value.trim();
  const price=parseFloat(document.getElementById("price").value);
  const mediaFile=document.getElementById("media").files[0];
  if(!name||!desc||!price) return alert("Completa todos los campos");

  let mediaUrl="";
  if(mediaFile){
    const data = new FormData();
    data.append("file", mediaFile);
    data.append("upload_preset","vendors_preset");
    data.append("folder","ml_default");
    const res = await fetch(`https://api.cloudinary.com/v1_1/df79cjklp/upload`, {method:"POST", body:data});
    const json = await res.json();
    mediaUrl = json.secure_url;
  }

  db.collection("products").add({name, description:desc, price, media:mediaUrl})
    .then(()=>{ 
      showModalMessage("Producto subido"); 
      document.getElementById("name").value='';
      document.getElementById("description").value='';
      document.getElementById("price").value='';
      document.getElementById("media").value='';
    })
    .catch(e=>alert(e.message));
}

// --- Editar y Eliminar Producto ---
function editProduct(id,name,desc,price){
  const newName = prompt("Nombre", name);
  const newDesc = prompt("Descripción", desc);
  const newPrice = parseFloat(prompt("Precio", price));
  if(!newName || !newDesc || !newPrice) return;
  db.collection("products").doc(id).update({name:newName, description:newDesc, price:newPrice})
    .then(()=>showModalMessage("Producto actualizado"))
    .catch(e=>alert(e.message));
}
function deleteProduct(id){
  if(!confirm("Eliminar producto?")) return;
  db.collection("products").doc(id).delete().then(()=>showModalMessage("Producto eliminado")).catch(e=>alert(e.message));
}

// --- Carrito ---
function addToCart(id,name,price,media){ cart.push({id,name,price,media}); localStorage.setItem("cart",JSON.stringify(cart)); renderCart(); showModalMessage("Añadido al carrito"); }
function renderCart(){ const list = document.getElementById("cartList"); if(cart.length===0){ list.innerHTML="<i>Carrito vacío</i>"; return; } let html=""; cart.forEach((p,i)=> html+=`<div>${p.name} - $${p.price} <button onclick="removeFromCart(${i})">Eliminar</button></div>`); list.innerHTML=html; }
function removeFromCart(index){ cart.splice(index,1); localStorage.setItem("cart",JSON.stringify(cart)); renderCart(); }
function emptyCart(){ if(confirm("Vaciar carrito?")){ cart=[]; localStorage.setItem("cart","[]"); renderCart(); } }
function viewCart(){ renderCart(); showModalMessage("Carrito actualizado"); }

// --- Compra ---
function openPurchaseForm(){
  if(cart.length===0) return alert("Carrito vacío");
  openModal(`
    <h3>Formulario de Compra</h3>
    <input id="buyerName" placeholder="Nombre completo">
    <input id="buyerPhone" placeholder="Teléfono">
    <input id="buyerWhats" placeholder="WhatsApp">
    <input id="buyerAddress" placeholder="Dirección">
    <input id="buyerEmail" placeholder="Email">
    <button onclick="submitPurchase()">Enviar Compra</button>
  `);
}
function submitPurchase(){
  const name=document.getElementById("buyerName").value.trim();
  const phone=document.getElementById("buyerPhone").value.trim();
  const whatsapp=document.getElementById("buyerWhats").value.trim();
  const address=document.getElementById("buyerAddress").value.trim();
  const email=document.getElementById("buyerEmail").value.trim();
  if(!name||!phone||!whatsapp||!address||!email) return alert("Completa todos los campos");

  db.collection("orders").add({
    user:auth.currentUser.uid,
    userEmail:auth.currentUser.email,
    buyerName:name, phone, whatsapp, address, email,
    products:cart, status:"pendiente", comprobante:""
  }).then(()=>{
    cart=[]; localStorage.setItem("cart","[]"); renderCart(); showModalMessage("Compra enviada"); closeModal();
  }).catch(e=>alert(e.message));
}

// --- Historial Usuario ---
function loadUserOrders(){
  const history=document.getElementById("purchaseHistory");
  db.collection("orders").where("user","==",auth.currentUser.uid).onSnapshot(snapshot=>{
    let html="";
    snapshot.forEach(doc=>{
      const o=doc.data();
      let productsHtml = o.products.map(p=>`<li>${p.name} - $${p.price}</li>`).join("");
      html+=`<div class="order">
        <strong>Compra #${doc.id}</strong> - Estado:
