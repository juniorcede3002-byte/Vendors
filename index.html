<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vendors | Professional Dashboard</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
:root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --bg-body: #f1f5f9;
    --bg-card: #ffffff;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --border: #e2e8f0;
    --radius: 12px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; }

header { 
    background: #ffffff; padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; 
    align-items: center; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    box-sizing: border-box;
}
.logo { font-weight: 800; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }

.container { max-width: 1000px; margin: 90px auto 40px; padding: 0 20px; display: none; }

.tabs { display: flex; background: #fff; padding: 5px; border-radius: 14px; gap: 4px; margin-bottom: 25px; box-shadow: var(--shadow); overflow-x: auto; }
.tab-btn { flex: 1; padding: 12px; cursor: pointer; border: none; border-radius: 10px; background: transparent; color: var(--text-muted); font-weight: 600; white-space: nowrap; transition: 0.2s; }
.tab-btn.active { background: var(--primary); color: #fff; }

.card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border); }
.tab-content { display: none; }
.tab-content.active { display: block; }

.form-group { margin-bottom: 15px; text-align: left; }
.form-group label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; }
input, textarea, select { width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.95rem; box-sizing: border-box; outline: none; transition: border 0.2s; }

.btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
.btn-primary { background: var(--primary); color: white; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
.btn-danger { background: #fee2e2; color: #dc2626; }

.order-item { border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 15px; background: #f8fafc; }
.status-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
.status-pendiente { background: #fef3c7; color: #92400e; }
.status-entregado { background: #dcfce7; color: #166534; }
.status-revision { background: #dbeafe; color: #1e40af; }

.product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
.product-card { background: #fff; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
.product-card img { width: 100%; height: 160px; object-fit: cover; }

.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
.modal-content { background: white; padding: 25px; border-radius: 16px; width: 100%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto; }

canvas { border: 1px solid var(--border); border-radius: 8px; background: #fff; width: 100%; height: 120px; }
</style>
</head>
<body>

<header>
  <div class="logo"><i class="fa-solid fa-bag-shopping"></i> VENDORS</div>
  <div id="authButtons" style="display: flex; gap: 8px;">
    <button class="btn btn-outline" onclick="showLoginForm()">Entrar</button>
    <button class="btn btn-primary" onclick="showRegisterForm()">Crear Cuenta</button>
  </div>
  <div id="userInfo" style="display:none; gap: 10px;">
    <button class="btn btn-outline" onclick="openConfig()"><i class="fa-solid fa-user-gear"></i></button>
    <button class="btn btn-danger" onclick="logout()"><i class="fa-solid fa-power-off"></i></button>
  </div>
</header>

<div class="container" id="dashboard">
  <div class="tabs">
    <button class="tab-btn active" data-tab="productsTab">Tienda</button>
    <button class="tab-btn" data-tab="cartTab">Carrito</button>
    <button class="tab-btn" data-tab="ordersTab">Mis Compras</button>
    <button class="tab-btn" id="adminTabBtn" data-tab="adminTab" style="display:none;">Panel Admin</button>
  </div>

  <div id="productsTab" class="tab-content active">
    <div class="card" style="display: flex; gap: 10px;">
        <input id="search" placeholder="Buscar producto..." oninput="filterProducts()">
    </div>
    <div id="productsList" class="product-grid"></div>
  </div>

  <div id="cartTab" class="tab-content">
    <div class="card">
        <h3>Tu Carrito</h3>
        <div id="cartList"></div>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="openCheckoutForm()">Finalizar Compra</button>
            <button class="btn btn-outline" onclick="emptyCart()">Vaciar</button>
        </div>
    </div>
  </div>

  <div id="ordersTab" class="tab-content">
    <div class="card">
        <h3>Historial de Pedidos</h3>
        <div id="purchaseHistory">Cargando...</div>
    </div>
  </div>

  <div id="adminTab" class="tab-content">
    <div class="card">
        <h3>Subir Nuevo Producto</h3>
        <div class="form-group"><label>Nombre</label><input id="name"></div>
        <div class="form-group"><label>Precio</label><input id="price" type="number"></div>
        <div class="form-group"><label>Imagen</label><input id="media" type="file"></div>
        <button class="btn btn-primary" onclick="uploadProduct()">Publicar</button>
    </div>
    <div class="card">
        <h3>Gestión de Pedidos</h3>
        <div id="adminOrdersList"></div>
    </div>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <button onclick="closeModal()" style="position:absolute; top:15px; right:15px; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
  authDomain: "proyectovendor.firebaseapp.com",
  projectId: "proyectovendor"
});
const db = firebase.firestore();
const auth = firebase.auth();

let cart = JSON.parse(localStorage.getItem("cart")) || [];
let role = "usuario";

// --- AUTH ---
auth.onAuthStateChanged(user => {
  if(user){ 
    initUser(user); 
  } else { 
    document.getElementById("authButtons").style.display="flex"; 
    document.getElementById("userInfo").style.display="none"; 
    document.getElementById("dashboard").style.display="none"; 
  }
});

async function initUser(user){
  document.getElementById("authButtons").style.display="none";
  document.getElementById("userInfo").style.display="flex";
  role = (user.email === "admin@vendors.com") ? "admin" : "usuario";
  document.getElementById("dashboard").style.display="block";
  if(role === "admin") document.getElementById("adminTabBtn").style.display="block";
  setUpTabs();
  loadProducts();
  renderCart();
  loadOrders();
}

function showLoginForm(){
  openModal(`<h3>Iniciar Sesión</h3>
    <input id="loginEmail" placeholder="Email" style="margin-bottom:10px">
    <input id="loginPass" type="password" placeholder="Contraseña">
    <button class="btn btn-primary" style="width:100%; margin-top:15px" onclick="login()">Entrar</button>`);
}

function showRegisterForm(){
  openModal(`<h3>Crear Cuenta</h3>
    <input id="regEmail" placeholder="Email" style="margin-bottom:10px">
    <input id="regPass" type="password" placeholder="Contraseña">
    <button class="btn btn-primary" style="width:100%; margin-top:15px" onclick="register()">Registrarme</button>`);
}

function login(){ auth.signInWithEmailAndPassword(document.getElementById("loginEmail").value, document.getElementById("loginPass").value).then(()=>closeModal());}
function register(){ auth.createUserWithEmailAndPassword(document.getElementById("regEmail").value, document.getElementById("regPass").value).then(()=>closeModal());}
function logout(){ auth.signOut().then(()=>location.reload()); }

// --- COMPRA ---
function openCheckoutForm(){
  if(cart.length === 0) return alert("Carrito vacío");
  openModal(`
    <h3>Datos de Entrega</h3>
    <div class="form-group"><label>Nombre Completo</label><input id="chkName"></div>
    <div class="form-group"><label>Teléfono Movil</label><input id="chkPhone"></div>
    <div class="form-group"><label>WhatsApp</label><input id="chkWap"></div>
    <div class="form-group"><label>Correo Electrónico</label><input id="chkEmail" value="${auth.currentUser.email}"></div>
    <div class="form-group"><label>Ubicación exacta de entrega</label><textarea id="chkAddr"></textarea></div>
    <div class="form-group">
        <label>Método de Pago</label>
        <select id="chkPay">
            <option value="yappy">Yappy (+507 63892022)</option>
            <option value="ach">ACH (Banco General)</option>
            <option value="efectivo">Efectivo al recibir</option>
        </select>
    </div>
    <div class="form-group"><label>Adjuntar Pago (Opcional)</label><input type="file" id="chkFile"></div>
    <button class="btn btn-primary" style="width:100%" onclick="confirmPurchase()">Enviar Pedido</button>
  `);
}

async function confirmPurchase(){
    const file = document.getElementById("chkFile").files[0];
    let compUrl = "";
    if(file){
        const fd = new FormData(); fd.append("file", file); fd.append("upload_preset", "vendors_preset");
        const res = await fetch(`https://api.cloudinary.com/v1_1/df79cjklp/upload`, {method:"POST", body:fd});
        const j = await res.json(); compUrl = j.secure_url;
    }

    const order = {
        userId: auth.currentUser.uid,
        buyer: document.getElementById("chkName").value,
        phone: document.getElementById("chkPhone").value,
        whatsapp: document.getElementById("chkWap").value,
        email: document.getElementById("chkEmail").value,
        address: document.getElementById("chkAddr").value,
        paymentMethod: document.getElementById("chkPay").value,
        comprobante: compUrl,
        products: cart,
        status: compUrl ? "revision" : "pendiente",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection("orders").add(order);
    emptyCart(); closeModal(); showModalMessage("¡Pedido Realizado!");
}

// --- HISTORIAL ---
function loadOrders(){
  // Nota: Si no ves datos, elimina .orderBy() para probar sin índices de Firebase
  db.collection("orders").onSnapshot(snap => {
    let userH = "", adminH = "";
    snap.forEach(doc => {
      const o = doc.data();
      const card = `
        <div class="order-item">
          <div style="display:flex; justify-content:space-between">
            <b>Pedido #${doc.id.substring(0,5)}</b>
            <span class="status-badge status-${o.status}">${o.status}</span>
          </div>
          <div style="font-size:0.8rem; margin:10px 0">
            ${o.buyer} | ${o.phone}<br>
            Entregar en: ${o.address}
          </div>
          <button class="btn btn-outline" style="width:100%; font-size:0.7rem" onclick="viewOrder('${doc.id}')">Detalles / Subir Pago</button>
        </div>`;
      if(o.userId === auth.currentUser.uid) userH += card;
      adminH += card;
    });
    document.getElementById("purchaseHistory").innerHTML = userH || "Sin pedidos.";
    if(role === "admin") document.getElementById("adminOrdersList").innerHTML = adminH;
  });
}

async function viewOrder(id){
    const s = await db.collection("orders").doc(id).get();
    const o = s.data();
    let h = `<h3>Detalles de Pedido</h3>
    <p><b>Estado:</b> ${o.status}</p>
    <p><b>Pago:</b> ${o.paymentMethod}</p>
    <p><b>Productos:</b> ${o.products.map(p=>p.name).join(", ")}</p>`;
    
    if(role === 'admin'){
        h += `<select onchange="updateStatus('${id}', this.value)">
            <option value="pendiente" ${o.status==='pendiente'?'selected':''}>Pendiente</option>
            <option value="revision" ${o.status==='revision'?'selected':''}>Revisión</option>
            <option value="entregado" ${o.status==='entregado'?'selected':''}>Entregado</option>
        </select>`;
    }

    if(!o.comprobante) h += `<hr><label>Subir Comprobante:</label><input type="file" onchange="uploadComp('${id}', this.files[0])">`;
    else h += `<p><b>Comprobante:</b><br><img src="${o.comprobante}" style="width:100%"></p>`;
    
    openModal(h);
}

// --- OTROS ---
function setUpTabs(){ document.querySelectorAll(".tab-btn").forEach(b => { b.onclick = () => { document.querySelectorAll(".tab-btn, .tab-content").forEach(e=>e.classList.remove("active")); b.classList.add("active"); document.getElementById(b.dataset.tab).classList.add("active"); }; });}
function openModal(c){ modal.style.display="flex"; modalBody.innerHTML=c; }
function closeModal(){ modal.style.display="none"; }
function showModalMessage(m){ openModal(`<h4>${m}</h4>`); setTimeout(closeModal, 1500); }
async function uploadComp(id, f){
    const fd = new FormData(); fd.append("file", f); fd.append("upload_preset", "vendors_preset");
    const res = await fetch(`https://api.cloudinary.com/v1_1/df79cjklp/upload`, {method:"POST", body:fd});
    const j = await res.json();
    await db.collection("orders").doc(id).update({comprobante: j.secure_url, status: "revision"});
    closeModal();
}
function updateStatus(id, s){ db.collection("orders").doc(id).update({status: s}); }
function renderCart(){
    const l = document.getElementById("cartList");
    if(cart.length===0){ l.innerHTML="Vacío"; return; }
    l.innerHTML = cart.map(i => `<div>${i.name} - $${i.price}</div>`).join("");
}
function emptyCart(){ cart=[]; localStorage.removeItem("cart"); renderCart(); }
function loadProducts(){
    db.collection("products").onSnapshot(s => {
        let h = "";
        s.forEach(d => { const p = d.data(); h += `<div class="product-card"><img src="${p.media}"><div style="padding:10px"><b>${p.name}</b><br>$${p.price}<br><button class="btn btn-primary" onclick="addToCart('${d.id}','${p.name}',${p.price},'${p.media}')">Comprar</button></div></div>`; });
        document.getElementById("productsList").innerHTML = h;
    });
}
function addToCart(id, n, p, m){ cart.push({id,n,price:p,media:m}); localStorage.setItem("cart", JSON.stringify(cart)); renderCart(); showModalMessage("Añadido"); }
async function uploadProduct(){
    const f = document.getElementById("media").files[0];
    const fd = new FormData(); fd.append("file", f); fd.append("upload_preset", "vendors_preset");
    const res = await fetch(`https://api.cloudinary.com/v1_1/df79cjklp/upload`, {method:"POST", body:fd});
    const j = await res.json();
    await db.collection("products").add({name:document.getElementById("name").value, price:parseFloat(document.getElementById("price").value), media:j.secure_url});
    showModalMessage("Publicado");
}
function openConfig(){
    openModal(`<h3>Configuración</h3>
    <div class="form-group"><label>Nombre</label><input id="cfgN"></div>
    <button class="btn btn-primary" onclick="closeModal()">Guardar</button>`);
}
</script>
</body>
</html>
