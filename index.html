<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Vendor | Sistema de Ventas</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- Iconos -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

<style>
body { font-family: Arial,sans-serif; background:#f2f2f2; padding:20px; }
.container { max-width:700px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
input, textarea, select, button { width:100%; padding:10px; margin-top:10px; border-radius:5px; border:1px solid #ccc; }
button { background:#111; color:#fff; border:none; cursor:pointer; transition:0.2s; }
button:hover { opacity:0.9; }
.role { background:#eee; }
.product { border:1px solid #ddd; padding:10px; margin-top:15px; border-radius:8px; display:flex; flex-direction:column; gap:5px; background:#fafafa; }
.product img, .product video { width:100%; border-radius:6px; }
.product h3 { margin:5px 0; }
.product p { margin:5px 0; }
.price { font-weight:bold; color:#111; }
.actions { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }
.actions button { flex:1; display:flex; align-items:center; justify-content:center; gap:5px; }
#cartList { background:#fff3cd; padding:10px; border-radius:8px; margin-top:15px; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:8px; max-width:500px; width:90%; position:relative; }
.modal-content button.close { position:absolute; top:10px; right:10px; background:#f00; border:none; border-radius:50%; width:30px; height:30px; color:#fff; cursor:pointer; }
</style>
</head>

<body>
<div class="container">

<h2>Rol</h2>
<select id="role" class="role" onchange="toggleAdminFeatures(); loadProducts();">
  <option value="usuario">Usuario</option>
  <option value="admin">Admin</option>
</select>

<hr>

<div id="adminPanel">
<h2>Subir Producto</h2>
<input id="name" placeholder="Nombre">
<textarea id="description" placeholder="Descripción"></textarea>
<input id="price" type="number" placeholder="Precio">
<input id="media" type="file" accept="image/*,video/*">
<button onclick="uploadProduct()"><i class="fa fa-upload"></i> Subir</button>
</div>

<hr>

<h2>Buscar</h2>
<input id="search" placeholder="Buscar por nombre" oninput="loadProducts()">
<input id="maxPrice" type="number" placeholder="Precio máximo" oninput="loadProducts()">

<hr>

<h2>Productos</h2>
<div id="productsList"></div>

<hr>
<h2><i class="fa fa-shopping-cart"></i> Carrito</h2>
<div id="cartList"><i>Carrito vacío</i></div>
<button onclick="viewCart()"><i class="fa fa-eye"></i> Ver Carrito</button>
<button onclick="emptyCart()"><i class="fa fa-trash"></i> Vaciar Carrito</button>

</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <button class="close" onclick="closeModal()">&times;</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
  authDomain: "proyectovendor.firebaseapp.com",
  projectId: "proyectovendor"
});
const db = firebase.firestore();
const CLOUD_NAME="df79cjklp";
const UPLOAD_PRESET="vendors_preset";

/* ELEMENTOS */
const roleSelect = document.getElementById("role");
const productsList = document.getElementById("productsList");
const adminPanel = document.getElementById("adminPanel");
const nameInput = document.getElementById("name");
const descriptionInput = document.getElementById("description");
const priceInput = document.getElementById("price");
const mediaInput = document.getElementById("media");
const cartListDiv = document.getElementById("cartList");
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modalBody");

/* CARRITO EN LOCALSTORAGE */
let cart = JSON.parse(localStorage.getItem("cart")) || [];

/* PANEL ADMIN */
function toggleAdminFeatures(){
  adminPanel.style.display = roleSelect.value==="admin"?"block":"none";
}
toggleAdminFeatures();

/* SUBIR PRODUCTO */
async function uploadProduct(){
  const file = mediaInput.files[0];
  if(!file) return alert("Archivo requerido");
  if(!nameInput.value.trim() || !priceInput.value) return alert("Nombre y precio obligatorios");

  const form=new FormData();
  form.append("file",file);
  form.append("upload_preset",UPLOAD_PRESET);

  const isVideo=file.type.startsWith("video");
  const endpoint=isVideo?"video":"image";

  const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${endpoint}/upload`,{method:"POST",body:form});
  const data=await res.json();
  if(!data.secure_url) return alert("Error subir archivo");

  await db.collection("products").add({
    name:nameInput.value.trim(),
    description:descriptionInput.value.trim(),
    price:Number(priceInput.value),
    mediaUrl:data.secure_url,
    mediaType:isVideo?"video":"image",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Producto subido");
  nameInput.value=""; descriptionInput.value=""; priceInput.value=""; mediaInput.value="";
}

/* LISTAR PRODUCTOS */
function loadProducts(){
  const role = roleSelect.value;
  const search = document.getElementById("search").value.toLowerCase();
  const maxPrice = document.getElementById("maxPrice").value;

  db.collection("products").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    productsList.innerHTML="";
    snapshot.forEach(doc=>{
      const p = doc.data();
      if((search && !p.name.toLowerCase().includes(search)) || (maxPrice && p.price>maxPrice)) return;

      productsList.innerHTML+=`
        <div class="product">
          ${p.mediaType==="video"?`<video src="${p.mediaUrl}" controls></video>`:`<img src="${p.mediaUrl}">`}
          <h3>${p.name}</h3>
          <p>${p.description}</p>
          <b>$${p.price}</b>
          <div class="actions">
            <button onclick="showContact('${p.name}')"><i class="fa fa-phone"></i> Contactar</button>
            <button onclick="addToCart('${doc.id}','${p.name}',${p.price})"><i class="fa fa-cart-plus"></i> Añadir al carrito</button>
            ${role==="admin"?`
              <button onclick="editProduct('${doc.id}','${p.name}','${p.description}',${p.price})"><i class="fa fa-edit"></i> Editar</button>
              <button onclick="deleteProduct('${doc.id}')"><i class="fa fa-trash"></i> Eliminar</button>`:""}
          </div>
        </div>
      `;
    });
  });
}

/* EDITAR PRODUCTO */
function editProduct(id,name,desc,price){
  const newName = prompt("Nombre:",name);
  const newDesc = prompt("Descripción:",desc);
  const newPrice = prompt("Precio:",price);
  if(newName && newDesc && newPrice){
    db.collection("products").doc(id).update({
      name:newName,
      description:newDesc,
      price:Number(newPrice)
    });
    alert("Producto actualizado");
  }
}

/* ELIMINAR PRODUCTO */
function deleteProduct(id){
  if(confirm("¿Eliminar producto?")) db.collection("products").doc(id).delete();
}

/* CONTACTAR */
function showContact(name){
  openModal(`Contacta al vendedor sobre: <b>${name}</b><br>Número: 63892022`);
}

/* CARRITO */
function addToCart(id,name,price){
  cart.push({id,name,price});
  localStorage.setItem("cart",JSON.stringify(cart));
  showModalMessage(`${name} añadido al carrito`);
}

function viewCart(){
  if(cart.length===0){ cartListDiv.innerHTML="<i>Carrito vacío</i>"; return; }
  let html="<ul>";
  let total=0;
  cart.forEach(item=>{ html+=`<li>${item.name} - $${item.price}</li>`; total+=item.price; });
  html+=`</ul><b>Total: $${total}</b>`;
  cartListDiv.innerHTML=html;
}

function emptyCart(){
  if(confirm("Vaciar carrito?")){
    cart=[];
    localStorage.setItem("cart",JSON.stringify(cart));
    cartListDiv.innerHTML="<i>Carrito vacío</i>";
  }
}

/* MODAL */
function openModal(content){
  modalBody.innerHTML=content;
  modal.style.display="flex";
}
function closeModal(){
  modal.style.display="none";
}
function showModalMessage(msg){
  openModal(msg);
  setTimeout(closeModal,1500);
}

loadProducts();
</script>

</body>
</html>
