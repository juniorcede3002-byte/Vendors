<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vendor Dashboard Simplificado</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>
<h1>Vendor Dashboard</h1>

<!-- AUTH -->
<div id="authButtons">
  <button onclick="showLoginForm()">Login</button>
  <button onclick="showRegisterForm()">Registrar</button>
</div>

<div id="userInfo" style="display:none">
  <span id="userEmail"></span>
  <button onclick="logout()">Salir</button>
</div>

<hr>

<!-- Productos -->
<h2>Productos</h2>
<div id="productsList"></div>

<!-- Admin subir producto -->
<div id="adminPanel" style="display:none">
  <h3>Subir Producto</h3>
  <input id="name" placeholder="Nombre"><br>
  <input id="price" placeholder="Precio"><br>
  <textarea id="description" placeholder="Descripción"></textarea><br>
  <input type="file" id="media" accept="image/*,video/*"><br>
  <button onclick="uploadProduct()">Subir Producto</button>
</div>

<hr>

<!-- Carrito -->
<h2>Carrito</h2>
<div id="cartList"></div>
<input type="file" id="paymentProof">
<button onclick="submitPurchase()">Comprar</button>

<hr>

<!-- Admin Ordenes -->
<div id="ordersListContainer" style="display:none">
<h2>Ordenes Recientes</h2>
<div id="ordersList"></div>
</div>

<!-- Modal simple -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0007; justify-content:center; align-items:center;">
  <div id="modalBody" style="background:#fff; padding:20px;"></div>
</div>

<script>
// --- FIREBASE ---
firebase.initializeApp({
  apiKey: "AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
  authDomain: "proyectovendor.firebaseapp.com",
  projectId: "proyectovendor"
});
const db = firebase.firestore();
const auth = firebase.auth();
const provider = new firebase.auth.GoogleAuthProvider();

// Variables
let cart = JSON.parse(localStorage.getItem("cart")) || [];
let role = "user";

// --- MODAL ---
function openModal(content){ document.getElementById("modal").style.display="flex"; document.getElementById("modalBody").innerHTML=content; }
function closeModal(){ document.getElementById("modal").style.display="none"; }
function showMessage(msg){ alert(msg); }

// --- LOGIN / REGISTRO ---
function showLoginForm(){ openModal(`
<h3>Login</h3>
<input id="loginEmail" placeholder="Email"><br>
<input id="loginPass" type="password" placeholder="Contraseña"><br>
<button onclick="login()">Entrar</button>
<button onclick="showRegisterForm()">Registrar</button>
`); }

function showRegisterForm(){ openModal(`
<h3>Registrar</h3>
<input id="regEmail" placeholder="Email"><br>
<input id="regPass" type="password" placeholder="Contraseña"><br>
<button onclick="register()">Registrar</button>
<button onclick="showLoginForm()">Login</button>
`); }

function login(){
  const email = document.getElementById("loginEmail").value;
  const pass = document.getElementById("loginPass").value;
  auth.signInWithEmailAndPassword(email, pass)
      .then(res => { closeModal(); initUser(res.user); })
      .catch(e => showMessage(e.message));
}

function register(){
  const email = document.getElementById("regEmail").value;
  const pass = document.getElementById("regPass").value;
  auth.createUserWithEmailAndPassword(email, pass)
      .then(res => { closeModal(); initUser(res.user); })
      .catch(e => showMessage(e.message));
}

function logout(){ auth.signOut().then(()=>location.reload()); }

// --- INIT USER ---
async function initUser(user){
  role = (user.email==="admin@vendors.com") ? "admin" : "user";
  document.getElementById("authButtons").style.display="none";
  document.getElementById("userInfo").style.display="block";
  document.getElementById("userEmail").innerText = user.email;
  if(role==="admin"){
    document.getElementById("adminPanel").style.display="block";
    document.getElementById("ordersListContainer").style.display="block";
    loadOrders();
  }
  loadProducts();
  renderCart();
}

// --- PRODUCTOS ---
async function loadProducts(){
  const productsList = document.getElementById("productsList");
  productsList.innerHTML="";
  const snapshot = await db.collection("products").get();
  snapshot.forEach(doc=>{
    const p = doc.data();
    const div = document.createElement("div");
    div.innerHTML = `${p.name} - $${p.price} <button onclick="addToCart('${doc.id}','${p.name}',${p.price},'${p.media||''}')">Añadir</button>
    ${role==='admin'?`<button onclick="editProductForm('${doc.id}')">Editar</button><button onclick="deleteProduct('${doc.id}')">Eliminar</button>`:''}`;
    productsList.appendChild(div);
  });
}

// --- SUBIR PRODUCTO ---
async function uploadProduct(){
  const name=document.getElementById("name").value;
  const price=parseFloat(document.getElementById("price").value);
  const desc=document.getElementById("description").value;
  const mediaFile=document.getElementById("media").files[0];
  if(!name||!price||!desc) return showMessage("Completa todos los campos");
  let mediaUrl="";
  if(mediaFile){
    const data=new FormData();
    data.append("file",mediaFile);
    data.append("upload_preset","vendors_preset");
    const res = await fetch("https://api.cloudinary.com/v1_1/df79cjklp/upload",{method:"POST",body:data});
    const json = await res.json();
    mediaUrl=json.secure_url;
  }
  db.collection("products").add({name,price,description:desc,media:mediaUrl})
    .then(()=>{ showMessage("Producto subido"); document.getElementById("name").value=""; document.getElementById("price").value=""; document.getElementById("description").value=""; document.getElementById("media").value=""; loadProducts(); });
}

// --- EDITAR PRODUCTO ---
async function editProductForm(id){
  const doc = await db.collection("products").doc(id).get();
  const p = doc.data();
  openModal(`
    <h3>Editar Producto</h3>
    <input id="editName" value="${p.name}"><br>
    <input id="editPrice" value="${p.price}"><br>
    <textarea id="editDesc">${p.description}</textarea><br>
    <button onclick="updateProduct('${id}')">Actualizar</button>
  `);
}

function updateProduct(id){
  const name = document.getElementById("editName").value;
  const price = parseFloat(document.getElementById("editPrice").value);
  const desc = document.getElementById("editDesc").value;
  db.collection("products").doc(id).update({name,price,description:desc}).then(()=>{ closeModal(); loadProducts(); });
}

// --- ELIMINAR PRODUCTO ---
function deleteProduct(id){ if(confirm("Eliminar producto?")) db.collection("products").doc(id).delete().then(()=>loadProducts()); }

// --- CARRITO ---
function addToCart(id,name,price,media){ cart.push({id,name,price,media,qty:1}); localStorage.setItem("cart",JSON.stringify(cart)); renderCart(); }

function renderCart(){
  const cartList = document.getElementById("cartList");
  cartList.innerHTML="";
  let total=0;
  cart.forEach((item,i)=>{
    total += item.price*item.qty;
    const div = document.createElement("div");
    div.innerHTML = `${item.name} x${item.qty} - $${item.price*item.qty} <button onclick="changeQty(${i},1)">+</button> <button onclick="changeQty(${i},-1)">-</button> <button onclick="removeFromCart(${i})">Eliminar</button>`;
    cartList.appendChild(div);
  });
  const t = document.createElement("p"); t.innerText="Total: $"+total; cartList.appendChild(t);
}

function changeQty(i,d){ cart[i].qty += d; if(cart[i].qty<1) cart[i].qty=1; localStorage.setItem("cart",JSON.stringify(cart)); renderCart(); }
function removeFromCart(i){ cart.splice(i,1); localStorage.setItem("cart",JSON.stringify(cart)); renderCart(); }

// --- COMPRAS ---
async function submitPurchase(){
  if(cart.length===0) return showMessage("Carrito vacío");
  const proofFile = document.getElementById("paymentProof").files[0];
  if(!proofFile) return showMessage("Adjunta comprobante");
  const data = new FormData();
  data.append("file", proofFile);
  data.append("upload_preset","vendors_preset");
  const res = await fetch("https://api.cloudinary.com/v1_1/df79cjklp/upload",{method:"POST",body:data});
  const json = await res.json();
  const user = auth.currentUser;
  await db.collection("orders").add({
    user:user.uid,
    email:user.email,
    items:cart,
    total: cart.reduce((a,b)=>a+b.price*b.qty,0),
    proof:json.secure_url,
    status:"revision",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  cart=[]; localStorage.setItem("cart",JSON.stringify(cart)); renderCart();
  showMessage("Compra enviada");
}

// --- ORDENES ADMIN ---
async function loadOrders(){
  const ordersList = document.getElementById("ordersList");
  ordersList.innerHTML="";
  const snapshot = await db.collection("orders").orderBy("createdAt","desc").get();
  snapshot.forEach(doc=>{
    const o = doc.data();
    const div = document.createElement("div");
    div.innerHTML = `${o.email} - $${o.total} - ${o.status} 
    <button onclick="updateOrderStatus('${doc.id}','revision')">Revision</button>
    <button onclick="updateOrderStatus('${doc.id}','verificado')">Pago Confirmado</button>
    <button onclick="updateOrderStatus('${doc.id}','en camino')">En Camino</button>
    <button onclick="updateOrderStatus('${doc.id}','finalizado')">Finalizado</button>
    <button onclick="updateOrderStatus('${doc.id}','cancelada')">Cancelar</button>`;
    ordersList.appendChild(div);
  });
}

function updateOrderStatus(id,status){ db.collection("orders").doc(id).update({status}).then(()=>loadOrders()); }

</script>
</body>
</html>
