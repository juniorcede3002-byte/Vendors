<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Vendor | Dashboard Integrado</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0}
header{background:#111;color:#fff;padding:15px;display:flex;justify-content:space-between;align-items:center;position:fixed;width:100%;top:0;z-index:100}
button,input,textarea,select{padding:10px;border-radius:6px;border:1px solid #ccc;width:100%;margin-top:8px}
button{background:#111;color:#fff;border:none;cursor:pointer}
.container{max-width:1100px;margin:auto;padding:100px 20px;display:none}
.tabs{display:flex;gap:5px;flex-wrap:wrap}
.tabs button{flex:1;background:#ddd}
.tabs button.active{background:#111;color:#fff}
.tab-content{display:none;background:#fff;padding:20px;border-radius:8px;margin-top:10px}
.tab-content.active{display:block}
.product,.order{border:1px solid #ddd;padding:10px;margin-top:10px;border-radius:6px}
.actions{display:flex;gap:5px;flex-wrap:wrap}
.actions button{flex:1}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:999}
.modal-content{background:#fff;padding:20px;border-radius:8px;max-width:650px;width:95%;max-height:90%;overflow:auto;position:relative}
.close{position:absolute;top:10px;right:10px;background:red;color:#fff;border:none;border-radius:50%;width:30px;height:30px}
canvas{border:1px solid #000}
.status-pendiente{color:#ff9800}
.status-revision-de-pago{color:#2196f3}
.status-pago-verificado{color:#4caf50}
.status-en-camino{color:#9c27b0}
.status-entregado{color:#000}
.status-cancelada{color:#f44336}
</style>
</head>

<body>

<header>
  Vendor Dashboard
  <div id="authButtons">
    <button onclick="showLoginForm()">Login</button>
    <button onclick="showRegisterForm()">Registro</button>
    <button onclick="loginWithGoogle()">Google</button>
  </div>
  <div id="userInfo" style="display:none">
    <span id="userEmail"></span>
    <button onclick="openConfig()">Configuración</button>
    <button onclick="logout()">Salir</button>
  </div>
</header>

<div class="container" id="dashboard">
  <div class="tabs">
    <button class="tab-btn active" data-tab="productsTab">Productos</button>
    <button class="tab-btn" data-tab="cartTab">Carrito</button>
    <button class="tab-btn" data-tab="ordersTab">Mis Compras</button>
    <button class="tab-btn" data-tab="adminTab">Admin</button>
  </div>

  <div id="productsTab" class="tab-content active">
    <h2>Productos</h2>
    <div id="productsList"></div>
  </div>

  <div id="cartTab" class="tab-content">
    <h2>Carrito</h2>
    <div id="cartList"></div>
    <button onclick="openCheckoutForm()">Finalizar Compra</button>
    <button onclick="emptyCart()">Vaciar</button>
  </div>

  <div id="ordersTab" class="tab-content">
    <h2>Historial de Compras</h2>
    <div id="purchaseHistory"></div>
  </div>

  <div id="adminTab" class="tab-content">
    <h2>Panel Admin</h2>
    <input id="name" placeholder="Nombre producto">
    <textarea id="description" placeholder="Descripción"></textarea>
    <input id="price" type="number" placeholder="Precio">
    <input id="media" type="file">
    <button onclick="uploadProduct()">Subir Producto</button>
    <hr>
    <h3>Gestión de Pedidos</h3>
    <div id="ordersList"></div>
  </div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <button class="close" onclick="closeModal()">×</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* =======================
   FIREBASE CONFIG
======================= */
firebase.initializeApp({
  apiKey: "AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
  authDomain: "proyectovendor.firebaseapp.com",
  projectId: "proyectovendor",
  storageBucket: "proyectovendor.appspot.com",
  messagingSenderId: "1033243956412",
  appId: "1:1033243956412:web:2c5dcbf9e92f5c3c0e4c73"
});
const db = firebase.firestore();
const auth = firebase.auth();
const provider = new firebase.auth.GoogleAuthProvider();

/* =======================
   VARIABLES
======================= */
let cart = JSON.parse(localStorage.getItem("cart")) || [];
let role = "usuario";

/* =======================
   MODAL
======================= */
function openModal(html){ modal.style.display="flex"; modalBody.innerHTML=html; }
function closeModal(){ modal.style.display="none"; }
function showMsg(msg){ openModal(`<p>${msg}</p>`); setTimeout(closeModal,1500); }

/* =======================
   AUTH
======================= */
auth.onAuthStateChanged(user=>{
  if(user) initUser(user);
  else{
    dashboard.style.display="none";
    authButtons.style.display="block";
    userInfo.style.display="none";
  }
});

function loginWithGoogle(){ auth.signInWithPopup(provider); }
function logout(){ auth.signOut(); }

function showLoginForm(){
  openModal(`
  <h3>Login</h3>
  <input id="le" placeholder="Email">
  <input id="lp" type="password" placeholder="Contraseña">
  <button onclick="auth.signInWithEmailAndPassword(le.value,lp.value)">Entrar</button>`);
}

function showRegisterForm(){
  openModal(`
  <h3>Registro</h3>
  <input id="re" placeholder="Email">
  <input id="rp" type="password" placeholder="Contraseña">
  <button onclick="auth.createUserWithEmailAndPassword(re.value,rp.value)">Crear</button>`);
}

/* =======================
   INIT USER
======================= */
async function initUser(user){
  userEmail.innerText=user.email;
  authButtons.style.display="none";
  userInfo.style.display="block";
  dashboard.style.display="block";

  role = user.email==="admin@vendors.com"?"admin":"usuario";
  document.querySelector("[data-tab='adminTab']").style.display =
    role==="admin"?"block":"none";

  const ref=db.collection("users").doc(user.uid);
  if(!(await ref.get()).exists){
    ref.set({email:user.email,name:user.displayName||""});
  }

  loadProducts();
  loadUserOrders();
  loadOrders();
  renderCart();
}

/* =======================
   PRODUCTS
======================= */
function loadProducts(){
  db.collection("products").onSnapshot(s=>{
    productsList.innerHTML="";
    s.forEach(d=>{
      const p=d.data();
      productsList.innerHTML+=`
      <div class="product">
        <b>${p.name}</b> - $${p.price}<br>${p.description}
        ${p.media?`<img src="${p.media}" width="120">`:``}
        <button onclick="addToCart('${d.id}','${p.name}',${p.price},'${p.media||''}')">Añadir</button>
      </div>`;
    });
  });
}

async function uploadProduct(){
  let file=media.files[0],url="";
  if(file){
    let fd=new FormData();
    fd.append("file",file);
    fd.append("upload_preset","vendors_preset");
    let r=await fetch("https://api.cloudinary.com/v1_1/df79cjklp/upload",{method:"POST",body:fd});
    url=(await r.json()).secure_url;
  }
  db.collection("products").add({
    name:name.value,
    description:description.value,
    price:Number(price.value),
    media:url
  });
  showMsg("Producto subido");
}

/* =======================
   CART
======================= */
function addToCart(id,name,price,media){
  cart.push({id,name,price,media});
  localStorage.setItem("cart",JSON.stringify(cart));
  renderCart();
}

function renderCart(){
  cartList.innerHTML="";
  let total=0;
  cart.forEach((p,i)=>{
    total+=p.price;
    cartList.innerHTML+=`
    <div class="product">${p.name} - $${p.price}
    <button onclick="removeFromCart(${i})">Quitar</button></div>`;
  });
  cartList.innerHTML+=`<b>Total: $${total.toFixed(2)}</b>`;
}

function removeFromCart(i){
  cart.splice(i,1);
  localStorage.setItem("cart",JSON.stringify(cart));
  renderCart();
}

function emptyCart(){ cart=[]; renderCart(); }

/* =======================
   CHECKOUT
======================= */
function openCheckoutForm(){
  openModal(`
  <h3>Finalizar compra</h3>
  <input id="cn" placeholder="Nombre">
  <input id="cp" placeholder="Teléfono">
  <input id="ca" placeholder="Dirección">
  <select id="pm" onchange="updatePayInfo()">
    <option value="yappy">Yappy</option>
    <option value="ach">ACH</option>
    <option value="efectivo">Efectivo</option>
  </select>
  <div id="payInfo"></div>
  <button onclick="finalizePurchase()">Confirmar</button>`);
  updatePayInfo();
}

function updatePayInfo(){
  payInfo.innerText =
    pm.value==="yappy"?"Yappy → +507 63892022 Emanuel Cedeño":
    pm.value==="ach"?"ACH → Banco General 0454966165208":
    "Pago en efectivo al recibir";
}

async function finalizePurchase(){
  await db.collection("orders").add({
    user:auth.currentUser.uid,
    userEmail:auth.currentUser.email,
    buyerName:cn.value,
    phone:cp.value,
    address:ca.value,
    products:cart,
    payment:pm.value,
    status:"pendiente",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  cart=[];
  renderCart();
  closeModal();
  showMsg("Compra creada");
}

/* =======================
   USER ORDERS
======================= */
function loadUserOrders(){
  db.collection("orders").where("user","==",auth.currentUser.uid)
  .onSnapshot(s=>{
    purchaseHistory.innerHTML="";
    s.forEach(d=>{
      const o=d.data();
      purchaseHistory.innerHTML+=`
      <div class="order">
        Estado: <b>${o.status}</b>
        <button onclick="uploadProof('${d.id}')">Subir comprobante</button>
      </div>`;
    });
  });
}

function uploadProof(id){
  openModal(`<input type="file" onchange="sendProof('${id}',this.files[0])">`);
}

async function sendProof(id,file){
  let fd=new FormData();
  fd.append("file",file);
  fd.append("upload_preset","vendors_preset");
  let r=await fetch("https://api.cloudinary.com/v1_1/df79cjklp/upload",{method:"POST",body:fd});
  let url=(await r.json()).secure_url;
  db.collection("orders").doc(id).update({comprobante:url});
  showMsg("Comprobante subido");
}

/* =======================
   ADMIN ORDERS
======================= */
function loadOrders(){
  if(role!=="admin")return;
  db.collection("orders").onSnapshot(s=>{
    ordersList.innerHTML="";
    s.forEach(d=>{
      const o=d.data();
      ordersList.innerHTML+=`
      <div class="order">
        ${o.userEmail} - ${o.status}
        <select onchange="db.collection('orders').doc('${d.id}').update({status:this.value})">
          <option>pendiente</option>
          <option>revision de pago</option>
          <option>pago verificado</option>
          <option>en camino</option>
          <option>entregado</option>
        </select>
        ${o.status==="en camino"?`<button onclick="captureSignature('${d.id}')">Firma</button>`:""}
      </div>`;
    });
  });
}

/* =======================
   SIGNATURE
======================= */
function captureSignature(id){
  openModal(`
  <h3>Firma</h3>
  <canvas id="sig" width="400" height="200"></canvas>
  <button onclick="saveSignature('${id}')">Guardar</button>`);
  const c=sig,ctx=c.getContext("2d");
  let d=false;
  c.onmousedown=()=>d=true;
  c.onmouseup=()=>{d=false;ctx.beginPath()};
  c.onmousemove=e=>{
    if(!d)return;
    ctx.lineWidth=2;
    ctx.lineTo(e.offsetX,e.offsetY);
    ctx.stroke();
  };
}

function saveSignature(id){
  db.collection("orders").doc(id)
  .update({deliveryProof:sig.toDataURL(),status:"entregado"});
  closeModal();
  showMsg("Entrega confirmada");
}
</script>
</body>
</html>