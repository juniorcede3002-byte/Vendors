<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Vendors Pro | Admin & Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; background: #0f172a; color: #e2e8f0; overflow-x: hidden; }
        .hidden { display: none !important; }
        .card { background: #1e293b; border: 1px solid #334155; padding: 20px; border-radius: 12px; margin-bottom: 16px; }
        .grid-products { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; outline: none; }
        input:focus, select:focus { border-color: #38bdf8; }
        button { padding: 10px 20px; border-radius: 8px; border: none; background: #38bdf8; color: #000; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        button:hover { background: #7dd3fc; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button.secondary { background: #475569; color: white; }
        button.danger { background: #ef4444; color: white; }
        button.success { background: #22c55e; color: white; }
        
        /* Sidebar Admin */
        .sidebar { width: 260px; background: #1e293b; border-right: 1px solid #334155; height: 100vh; position: fixed; left: 0; top: 0; padding: 20px; }
        .admin-main { margin-left: 260px; padding: 40px; width: calc(100% - 260px); }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; color: #94a3b8; cursor: pointer; margin-bottom: 5px; transition: 0.2s; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #38bdf8; color: #000; }

        /* Status colors */
        .status-pendiente { color: #fbbf24; }
        .status-pago_confirmado { color: #38bdf8; font-weight: bold; }
        .status-recibido { color: #22c55e; font-weight: bold; }
        .status-rechazado { color: #f87171; }

        /* Modal simple */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 20px; }
    </style>
</head>
<body>

<!-- LANDING -->
<section id="landing" class="min-h-screen flex items-center justify-center text-center">
    <div class="card max-w-md w-full p-12">
        <h1 class="text-5xl font-black text-sky-400 mb-4">Vendors</h1>
        <p class="text-slate-400 mb-8">Gestión de suministros y validación de compras.</p>
        <button id="goAuth" class="w-full text-lg py-4">Entrar al Sistema</button>
    </div>
</section>

<!-- AUTH -->
<section id="auth" class="hidden min-h-screen flex items-center justify-center">
    <div class="card w-full max-w-sm">
        <h2 class="text-2xl font-bold mb-6 text-center">Acceso</h2>
        <input id="email" type="email" placeholder="Correo electrónico">
        <input id="password" type="password" placeholder="Contraseña">
        <div class="flex flex-col gap-2 mt-4">
            <button id="login">Iniciar Sesión</button>
            <button id="register" class="secondary">Registrarse</button>
        </div>
        <button onclick="location.reload()" class="mt-4 text-sm text-slate-500 hover:text-white w-full">Volver</button>
    </div>
</section>

<!-- STORE (VISTA USUARIO) -->
<section id="store" class="hidden py-20">
    <div class="container mx-auto px-6">
        <div class="flex justify-between items-center mb-10">
            <div>
                <h2 class="text-3xl font-bold">Catálogo de Suministros</h2>
                <p id="user-welcome" class="text-slate-400"></p>
            </div>
            <div class="flex gap-4">
                <button onclick="toggleCart()" class="secondary relative">
                    <i class="fas fa-shopping-cart"></i> Carrito
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-sky-500 text-xs px-2 rounded-full">0</span>
                </button>
                <button onclick="showMyOrders()" class="secondary">Mis Pedidos</button>
                <button id="logout" class="danger">Salir</button>
            </div>
        </div>
        <div id="products-list" class="grid-products"></div>
    </div>
</section>

<!-- MODAL CARRITO / PAGO -->
<div id="cart-modal" class="modal-overlay hidden">
    <div class="card w-full max-w-lg overflow-y-auto max-h-[90vh]">
        <h2 class="text-2xl font-bold mb-4">Tu Pedido</h2>
        <div id="cart-items" class="space-y-3 mb-6"></div>
        
        <div class="border-t border-slate-700 pt-4 mt-4">
            <h3 class="font-bold mb-2">Información de Pago</h3>
            <select id="payment-method" onchange="updatePaymentInfo()">
                <option value="efectivo">Efectivo</option>
                <option value="yappy">Yappy (+507 6389-2022)</option>
                <option value="transferencia">Transferencia Bancaria</option>
            </select>
            <div id="payment-details" class="text-sm bg-slate-900 p-3 rounded mt-2 text-sky-300">
                Selecciona un método para ver los detalles.
            </div>
            <textarea id="order-notes" placeholder="Notas adicionales (ej: dirección de entrega, quién recibe)..." class="mt-4 h-24"></textarea>
            
            <div class="flex justify-between items-center mt-6">
                <span class="text-xl font-bold">Total: $<span id="cart-total">0</span></span>
                <div class="flex gap-2">
                    <button onclick="toggleCart()" class="secondary">Cerrar</button>
                    <button id="confirm-order-btn" class="success">Confirmar y Pagar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ADMIN (VISTA PANEL DESGLOSADO) -->
<section id="admin" class="hidden">
    <div class="sidebar">
        <div class="text-2xl font-black text-sky-400 mb-10 px-2">ADMIN PANEL</div>
        <nav>
            <div class="nav-item active" onclick="switchAdminTab('dashboard', this)">
                <i class="fas fa-chart-line"></i> Dashboard
            </div>
            <div class="nav-item" onclick="switchAdminTab('inventory', this)">
                <i class="fas fa-boxes"></i> Inventario
            </div>
            <div class="nav-item" onclick="switchAdminTab('orders', this)">
                <i class="fas fa-shopping-cart"></i> Solicitudes
            </div>
            <div class="nav-item" onclick="switchAdminTab('users', this)">
                <i class="fas fa-users"></i> Usuarios
            </div>
        </nav>
        <div class="absolute bottom-10 left-0 w-full px-6">
            <button id="logoutAdmin" class="danger w-full">Cerrar Sesión</button>
        </div>
    </div>

    <div class="admin-main">
        <!-- Tab Dashboard -->
        <div id="tab-dashboard" class="admin-tab">
            <h2 class="text-3xl font-bold mb-8">Resumen General</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="stats-container"></div>
        </div>

        <!-- Tab Inventario -->
        <div id="tab-inventory" class="admin-tab hidden">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold">Gestión de Inventario</h2>
                <button onclick="document.getElementById('form-add-p').classList.toggle('hidden')">+ Nuevo Item</button>
            </div>
            <div id="form-add-p" class="card hidden mb-8">
                <input id="pName" placeholder="Nombre del suministro">
                <input id="pPrice" type="number" placeholder="Precio ($)">
                <input id="pImg" type="file" accept="image/*">
                <button id="addProduct" class="mt-4 w-full">Guardar Suministro</button>
            </div>
            <div id="admin-inventory-list" class="space-y-2"></div>
        </div>

        <!-- Tab Solicitudes -->
        <div id="tab-orders" class="admin-tab hidden">
            <h2 class="text-3xl font-bold mb-8">Gestión de Pedidos</h2>
            <div id="admin-orders-list" class="space-y-4"></div>
        </div>

        <!-- Tab Usuarios -->
        <div id="tab-users" class="admin-tab hidden">
            <h2 class="text-3xl font-bold mb-8">Usuarios</h2>
            <div id="admin-users-list" class="bg-slate-800 rounded-xl overflow-hidden"></div>
        </div>
    </div>
</section>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, updateDoc, doc, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
        authDomain: "proyectovendor.firebaseapp.com",
        projectId: "proyectovendor"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const CLOUD_NAME = "df79cjklp";
    const UPLOAD_PRESET = "vendors_preset";

    const $ = id => document.getElementById(id);
    let cart = [];

    // NAVEGACIÓN
    const show = id => {
        ["landing", "auth", "store", "admin"].forEach(s => $(s).classList.add("hidden"));
        $(id).classList.remove("hidden");
    };

    window.switchAdminTab = (tabId, el) => {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        $(`tab-${tabId}`).classList.remove('hidden');
        el.classList.add('active');
        if(tabId === 'dashboard') loadStats();
        if(tabId === 'users') loadUsers();
    };

    // AUTH
    $("goAuth").onclick = () => show("auth");
    $("login").onclick = () => signInWithEmailAndPassword(auth, $("email").value, $("password").value).catch(e => alert("Error: " + e.message));
    $("register").onclick = async () => {
        try {
            const res = await createUserWithEmailAndPassword(auth, $("email").value, $("password").value);
            await addDoc(collection(db, "users_data"), { email: $("email").value, uid: res.user.uid, role: 'client', date: Date.now() });
            alert("Registro exitoso");
        } catch(e) { alert(e.message); }
    };
    $("logout").onclick = () => signOut(auth);
    $("logoutAdmin").onclick = () => signOut(auth);

    // CARRITO Y PAGO
    window.toggleCart = () => $("cart-modal").classList.toggle("hidden");

    window.updatePaymentInfo = () => {
        const method = $("payment-method").value;
        const info = $("payment-details");
        if(method === 'yappy') info.innerText = "Yappy: +507 6389-2022 (A nombre de Vendors Pro)";
        else if(method === 'transferencia') info.innerText = "Banco General: Cuenta Corriente 00-00-00-00 (Próximamente)";
        else info.innerText = "Pago contra entrega.";
    };

    window.addToCart = (p) => {
        cart.push(p);
        updateCartUI();
    };

    function updateCartUI() {
        $("cart-count").innerText = cart.length;
        const itemsDiv = $("cart-items");
        itemsDiv.innerHTML = "";
        let total = 0;
        cart.forEach((item, index) => {
            total += item.price;
            const div = document.createElement("div");
            div.className = "flex justify-between items-center bg-slate-800 p-2 rounded";
            div.innerHTML = `<span>${item.name}</span> <span>$${item.price} <button onclick="removeFromCart(${index})" class="text-red-400 ml-2">x</button></span>`;
            itemsDiv.appendChild(div);
        });
        $("cart-total").innerText = total;
    }

    window.removeFromCart = (index) => {
        cart.splice(index, 1);
        updateCartUI();
    };

    $("confirm-order-btn").onclick = async () => {
        if(cart.length === 0) return alert("Tu carrito está vacío.");
        const method = $("payment-method").value;
        const notes = $("order-notes").value;
        
        try {
            await addDoc(collection(db, "orders"), {
                user: auth.currentUser.email,
                uid: auth.currentUser.uid,
                products: cart,
                total: $("cart-total").innerText,
                paymentMethod: method,
                notes: notes,
                status: "pendiente", // pendiente -> pago_confirmado -> recibido
                date: Date.now()
            });
            alert("Pedido confirmado. Por favor procede con el pago si elegiste Yappy o Transferencia.");
            cart = [];
            updateCartUI();
            toggleCart();
        } catch(e) { alert(e.message); }
    };

    // CLIENTE: CARGAR PRODUCTOS
    async function loadStoreProducts() {
        onSnapshot(collection(db, "products"), snap => {
            const list = $("products-list");
            list.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                const div = document.createElement("div");
                div.className = "card flex flex-col";
                div.innerHTML = `
                    <img src="${p.img || 'https://via.placeholder.com/150'}" class="h-40 object-cover mb-4 rounded-lg">
                    <h3 class="text-xl font-bold text-sky-400">${p.name}</h3>
                    <p class="text-slate-400 mt-2 flex-1">Suministro verificado. Precio: $${p.price}</p>
                    <button class="mt-4 w-full" onclick='addToCart(${JSON.stringify(p)})'>Añadir al Carrito</button>
                `;
                list.appendChild(div);
            });
        });
    }

    window.showMyOrders = async () => {
        const q = query(collection(db, "orders"), where("uid", "==", auth.currentUser.uid));
        const snap = await getDocs(q);
        let content = "TUS PEDIDOS:\n\n";
        snap.forEach(d => {
            const o = d.data();
            content += `- Orden #${d.id.slice(0,5)}: ${o.status.toUpperCase()} ($${o.total})\n`;
            if(o.status === "pago_confirmado") {
                content += "  [ACCION: Confirma recepción abajo]\n";
            }
        });
        // Para simplificar, mostramos la lista en un modal o dashboard de órdenes
        renderOrdersList(snap, true);
    };

    function renderOrdersList(snap, isClient) {
        // Esta función se usa para pintar las órdenes tanto para admin como para user
        const target = isClient ? $("cart-items") : $("admin-orders-list");
        if(isClient) toggleCart(); // Reutilizamos el modal para el cliente
        
        target.innerHTML = isClient ? "<h3 class='font-bold mb-4'>Historial de Pedidos</h3>" : "";
        
        snap.forEach(d => {
            const o = d.data();
            const div = document.createElement("div");
            div.className = "card bg-slate-800/50 flex flex-col gap-2";
            let actions = "";
            
            if(!isClient) {
                if(o.status === 'pendiente') actions = `<button onclick="updateStatus('${d.id}', 'pago_confirmado')" class="success">Confirmar Pago</button> <button onclick="updateStatus('${d.id}', 'rechazado')" class="danger">Rechazar</button>`;
            } else {
                if(o.status === 'pago_confirmado') actions = `<button onclick="updateStatus('${d.id}', 'recibido')" class="success w-full">He recibido la mercancía</button>`;
            }

            div.innerHTML = `
                <div class="flex justify-between border-b border-slate-700 pb-2">
                    <span class="text-xs text-slate-500">ID: ${d.id.slice(0,8)}</span>
                    <span class="status-${o.status} uppercase text-xs font-bold">${o.status.replace('_',' ')}</span>
                </div>
                <p><strong>Total:</strong> $${o.total} (${o.paymentMethod})</p>
                <p class="text-xs text-slate-400">${o.user}</p>
                <div class="mt-2 space-y-2">${actions}</div>
            `;
            target.appendChild(div);
        });
    }

    // ADMIN: ÓRDENES
    function loadAdminOrders() {
        onSnapshot(query(collection(db, "orders"), orderBy("date", "desc")), snap => {
            renderOrdersList(snap, false);
        });
    }

    // ADMIN: OTROS
    async function loadStats() {
        const prodSnap = await getDocs(collection(db, "products"));
        const orderSnap = await getDocs(collection(db, "orders"));
        const userSnap = await getDocs(collection(db, "users_data"));
        $("stats-container").innerHTML = `
            <div class="card border-l-4 border-sky-400"><h3>Suministros</h3><p class="text-4xl font-bold">${prodSnap.size}</p></div>
            <div class="card border-l-4 border-amber-400"><h3>Pedidos</h3><p class="text-4xl font-bold">${orderSnap.size}</p></div>
            <div class="card border-l-4 border-emerald-400"><h3>Usuarios</h3><p class="text-4xl font-bold">${userSnap.size}</p></div>
        `;
    }

    // CRUD PRODUCTOS
    $("addProduct").onclick = async () => {
        const file = $("pImg").files[0];
        if (!file) return alert("Imagen requerida");
        const form = new FormData();
        form.append("file", file);
        form.append("upload_preset", UPLOAD_PRESET);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: form });
        const data = await res.json();
        await addDoc(collection(db, "products"), { name: $("pName").value, price: Number($("pPrice").value), img: data.secure_url, date: Date.now() });
        alert("Agregado");
    };

    function loadAdminInventory() {
        onSnapshot(collection(db, "products"), snap => {
            const list = $("admin-inventory-list");
            list.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                const div = document.createElement("div");
                div.className = "flex items-center justify-between p-3 bg-slate-800 rounded border border-slate-700";
                div.innerHTML = `<span>${p.name} - $${p.price}</span> <button class="danger p-1 text-xs" onclick="deleteItem('products', '${d.id}')">X</button>`;
                list.appendChild(div);
            });
        });
    }

    window.updateStatus = (id, status) => updateDoc(doc(db, "orders", id), { status });
    window.deleteItem = async (col, id) => { if(confirm("¿Eliminar?")) await deleteDoc(doc(db, col, id)); };

    // SESIÓN
    onAuthStateChanged(auth, user => {
        if (!user) return show("landing");
        if (user.email === "admin@vendors.com") {
            show("admin");
            loadAdminInventory();
            loadAdminOrders();
            loadStats();
        } else {
            show("store");
            $("user-welcome").innerText = user.email;
            loadStoreProducts();
        }
    });

</script>
</body>
</html>