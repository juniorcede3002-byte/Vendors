<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Vendors | Web de compras online</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0}
header{background:#111;color:#fff;padding:15px;display:flex;justify-content:space-between;position:fixed;width:100%;top:0;z-index:10}
button{cursor:pointer}
.container{max-width:1100px;margin:auto;padding:90px 20px;display:none}
.tabs{display:flex;gap:5px;flex-wrap:wrap}
.tabs button{flex:1;padding:10px;border:none;border-radius:5px}
.tabs button.active{background:#111;color:#fff}
.tab-content{display:none;background:#fff;padding:20px;border-radius:8px;margin-top:10px}
.tab-content.active{display:block}
.order{border:1px solid #ddd;padding:15px;margin-top:15px;border-radius:8px}
input,select,textarea{width:100%;padding:8px;margin-top:8px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:100}
.modal-content{background:#fff;padding:20px;border-radius:8px;width:90%;max-width:600px;max-height:90%;overflow:auto}
.status-pendiente{color:#ff9800;font-weight:bold}
.status-revision-de-pago{color:#2196f3;font-weight:bold}
.status-pago-verificado{color:#4caf50;font-weight:bold}
.status-en-camino{color:#9c27b0;font-weight:bold}
.status-entregado{color:#000;font-weight:bold}
</style>
</head>

<body>

<header>
  Vendors Dashboard
  <div id="authBtns">
    <button onclick="showLogin()">Login</button>
    <button onclick="showRegister()">Registro</button>
  </div>
  <div id="userBox" style="display:none">
    <span id="userEmail"></span>
    <button onclick="logout()">Salir</button>
  </div>
</header>

<div class="container" id="dashboard">

  <div class="tabs">
    <button class="tab-btn active" data-tab="productsTab">Productos</button>
    <button class="tab-btn" data-tab="cartTab">Carrito</button>
    <button class="tab-btn" data-tab="ordersTab">Mis Solicitudes</button>
    <button class="tab-btn" data-tab="adminTab" id="adminBtn" style="display:none">Admin</button>
  </div>

  <div id="productsTab" class="tab-content active">
    <h3>Productos</h3>
    <div id="productsList"></div>
  </div>

  <div id="cartTab" class="tab-content">
    <h3>Carrito</h3>
    <div id="cartList"></div>
    <button onclick="checkout()">Finalizar Compra</button>
  </div>

  <div id="ordersTab" class="tab-content">
    <h3>Mis Solicitudes</h3>
    <div id="userOrders">Cargando...</div>
  </div>

  <div id="adminTab" class="tab-content">
    <h3>Gestión de Pedidos</h3>
    <div id="adminOrders">Cargando...</div>
  </div>

</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <button onclick="closeModal()" style="float:right">✖</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
  authDomain: "proyectovendor.firebaseapp.com",
  projectId: "proyectovendor"
});
const db = firebase.firestore();
const auth = firebase.auth();

// ================= GLOBAL =================
let currentUser = null;
let isAdmin = false;
let cart = JSON.parse(localStorage.getItem("cart")) || [];

// ================= AUTH =================
auth.onAuthStateChanged(user=>{
  if(user){
    currentUser = user;
    isAdmin = user.email === "admin@vendors.com";

    document.getElementById("dashboard").style.display="block";
    document.getElementById("authBtns").style.display="none";
    document.getElementById("userBox").style.display="block";
    document.getElementById("userEmail").innerText = user.email;
    if(isAdmin) document.getElementById("adminBtn").style.display="block";

    loadProducts();
    loadOrders();
    renderCart();
  }else{
    location.reload();
  }
});

// ================= TABS =================
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  }
});

// ================= PRODUCTS =================
function loadProducts(){
  db.collection("products").onSnapshot(snap=>{
    let html="";
    snap.forEach(d=>{
      const p=d.data();
      html+=`
      <div class="order">
        <b>${p.name}</b> - $${p.price}
        <button onclick="addToCart('${d.id}','${p.name}',${p.price})">Agregar</button>
      </div>`;
    });
    document.getElementById("productsList").innerHTML=html;
  });
}

// ================= CART =================
function addToCart(id,name,price){
  cart.push({id,name,price});
  localStorage.setItem("cart",JSON.stringify(cart));
  renderCart();
}
function renderCart(){
  const div=document.getElementById("cartList");
  if(cart.length===0){div.innerHTML="Vacío";return;}
  div.innerHTML=cart.map(i=>`${i.name} - $${i.price}`).join("<br>");
}

// ================= CHECKOUT =================
function checkout(){
  if(cart.length===0)return alert("Carrito vacío");
  openModal(`
    <h3>Finalizar Pedido</h3>
    <input id="name" placeholder="Nombre">
    <input id="address" placeholder="Dirección">
    <select id="pay">
      <option value="yappy">Yappy</option>
      <option value="ach">ACH</option>
      <option value="efectivo">Efectivo</option>
    </select>
    <button onclick="confirmOrder()">Enviar</button>
  `);
}

async function confirmOrder(){
  await db.collection("orders").add({
    user: currentUser.uid,
    buyerName: name.value,
    address: address.value,
    payment: pay.value,
    products: cart,
    status: "pendiente",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  cart=[];
  localStorage.removeItem("cart");
  closeModal();
  alert("Pedido enviado");
}

// ================= ORDERS =================
function loadOrders(){
  let query=db.collection("orders").orderBy("createdAt","desc");
  if(!isAdmin) query=query.where("user","==",currentUser.uid);

  query.onSnapshot(snap=>{
    let userHtml="",adminHtml="";
    snap.forEach(doc=>{
      const o=doc.data();
      const total=o.products.reduce((s,p)=>s+p.price,0);

      const html=`
      <div class="order">
        <b>Pedido ${doc.id.substring(0,6)}</b>
        <span class="status-${o.status.replace(/ /g,'-')}">${o.status}</span>
        <p>Total: $${total}</p>
        ${!o.comprobante?`
          <input type="file" onchange="uploadProof('${doc.id}',this.files[0])">
        `:`<img src="${o.comprobante}" width="150">`}
        ${isAdmin?`
        <select onchange="updateStatus('${doc.id}',this.value)">
          <option ${o.status=='pendiente'?'selected':''}>pendiente</option>
          <option ${o.status=='revision de pago'?'selected':''}>revision de pago</option>
          <option ${o.status=='pago verificado'?'selected':''}>pago verificado</option>
          <option ${o.status=='en camino'?'selected':''}>en camino</option>
          <option ${o.status=='entregado'?'selected':''}>entregado</option>
        </select>`:""}
      </div>`;

      if(o.user===currentUser.uid) userHtml+=html;
      if(isAdmin) adminHtml+=html;
    });
    document.getElementById("userOrders").innerHTML=userHtml||"Sin pedidos";
    if(isAdmin) document.getElementById("adminOrders").innerHTML=adminHtml||"Sin pedidos";
  });
}

// ================= CLOUDINARY =================
async function uploadProof(id,file){
  const fd=new FormData();
  fd.append("file",file);
  fd.append("upload_preset","vendors_preset");

  const r=await fetch("https://api.cloudinary.com/v1_1/df79cjklp/upload",{method:"POST",body:fd});
  const j=await r.json();
  await db.collection("orders").doc(id).update({
    comprobante:j.secure_url,
    status:"revision de pago"
  });
}

// ================= ADMIN =================
function updateStatus(id,status){
  db.collection("orders").doc(id).update({status});
}

// ================= MODAL & AUTH UI =================
function openModal(html){modal.style.display="flex";modalBody.innerHTML=html}
function closeModal(){modal.style.display="none"}

function showLogin(){
  openModal(`<input id="le"><input id="lp" type="password"><button onclick="login()">Entrar</button>`);
}
function login(){auth.signInWithEmailAndPassword(le.value,lp.value).then(closeModal)}

function showRegister(){
  openModal(`<input id="re"><input id="rp" type="password"><button onclick="register()">Registrar</button>`);
}
function register(){auth.createUserWithEmailAndPassword(re.value,rp.value).then(closeModal)}

function logout(){auth.signOut()}
</script>

</body>
</html>
