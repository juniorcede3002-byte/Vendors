<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Vendors Pro | Sistema Avanzado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #38bdf8;
            --primary-dark: #0ea5e9;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --border: #334155;
            --text: #f1f5f9;
        }
        body { background: var(--bg-main); color: var(--text); font-family: 'Inter', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid var(--border); }
        .btn-primary { background: var(--primary); color: #000; font-weight: 600; transition: 0.3s; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .input-field { background: #0f172a; border: 1px solid var(--border); color: white; padding: 0.75rem; border-radius: 0.5rem; width: 100%; }
        .sidebar-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 8px; cursor: pointer; color: #94a3b8; transition: 0.2s; }
        .sidebar-item:hover { background: #334155; color: white; }
        .sidebar-item.active { background: var(--primary); color: #000; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .pending { background: #fef08a; color: #854d0e; }
        .approved { background: #bbf7d0; color: #166534; }
        .rejected { background: #fecaca; color: #991b1b; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-sky-500"></div>
    </div>

    <!-- Login/Auth Screen -->
    <div id="auth-screen" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="glass p-8 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-black text-sky-400">VENDORS <span class="text-white">PRO</span></h1>
                <p class="text-slate-400 mt-2">Gesti칩n de Suministros Corporativos</p>
            </div>
            
            <div class="space-y-4">
                <input id="email" type="email" placeholder="Correo corporativo" class="input-field">
                <input id="password" type="password" placeholder="Contrase침a" class="input-field">
                
                <button id="btn-login" class="btn-primary w-full py-3 rounded-lg shadow-lg">Iniciar Sesi칩n</button>
                
                <div class="flex justify-between items-center text-sm px-1">
                    <button id="btn-forgot" class="text-sky-400 hover:underline">쯆lvidaste tu contrase침a?</button>
                    <button id="btn-show-register" class="text-slate-400 hover:text-white">Crear cuenta</button>
                </div>
            </div>

            <div id="register-fields" class="hidden mt-6 pt-6 border-t border-slate-700 space-y-4">
                <input id="reg-name" type="text" placeholder="Nombre completo" class="input-field">
                <button id="btn-register" class="w-full bg-slate-700 py-2 rounded-lg hover:bg-slate-600">Registrar Solicitante</button>
            </div>
        </div>
    </div>

    <!-- Main Layout (App) -->
    <div id="app-screen" class="hidden flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar -->
        <aside class="w-full md:w-64 glass p-6 flex flex-col gap-8">
            <div class="text-2xl font-black text-sky-400 px-2">VP ADMIN</div>
            
            <nav class="flex flex-col gap-2 flex-grow" id="nav-menu">
                <!-- Se inyecta seg칰n el rol -->
            </nav>

            <div class="pt-6 border-t border-slate-700">
                <div class="flex items-center gap-3 px-2 mb-4">
                    <div class="w-10 h-10 rounded-full bg-sky-500 flex items-center justify-center font-bold text-black" id="user-avatar">?</div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-bold truncate" id="user-display-name">Usuario</p>
                        <p class="text-xs text-slate-400 truncate" id="user-display-role">Cargando...</p>
                    </div>
                </div>
                <button id="btn-logout" class="w-full bg-red-500/10 text-red-500 py-2 rounded-lg hover:bg-red-500 hover:text-white transition">
                    <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesi칩n
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow p-6 md:p-10 overflow-y-auto max-h-screen">
            <div id="content-area">
                <!-- Se inyecta el contenido de la pesta침a -->
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4">
        <div class="glass p-6 rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" id="modal-body"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Global Firebase Config
        const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY","authDomain":"proyectovendor.firebaseapp.com","projectId":"proyectovendor"}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vendors-pro-v1';

        let userProfile = null;

        // --- Helper: UI Management ---
        const view = (id) => {
            document.getElementById('loading').classList.add('hidden');
            if(id === 'auth') {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            } else {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
            }
        };

        // --- Auth Logic ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Si falla el login persistente, mantenemos la pantalla de auth
                }
            } catch (e) { console.error("Auth Init Error", e); }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info');
                const snap = await getDoc(userRef);
                
                if (snap.exists()) {
                    userProfile = snap.data();
                } else {
                    // Auto-crear perfil si no existe (primer login)
                    userProfile = { uid: user.uid, email: user.email, name: user.displayName || 'Nuevo Usuario', role: user.email === 'admin@vendors.com' ? 'admin' : 'applicant' };
                    await setDoc(userRef, userProfile);
                }
                
                renderUI();
                view('app');
            } else {
                view('auth');
            }
        });

        // --- Event Listeners ---
        document.getElementById('btn-login').onclick = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, pass).catch(err => alert("Error: " + err.message));
        };

        document.getElementById('btn-show-register').onclick = () => {
            document.getElementById('register-fields').classList.toggle('hidden');
        };

        document.getElementById('btn-register').onclick = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const name = document.getElementById('reg-name').value;
            if(!email || !pass || !name) return alert("Completa todos los campos");
            
            try {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                // El onAuthStateChanged se encargar치 del resto
            } catch (err) { alert(err.message); }
        };

        document.getElementById('btn-forgot').onclick = () => {
            const email = document.getElementById('email').value;
            if(!email) return alert("Ingresa tu correo primero");
            sendPasswordResetEmail(auth, email)
                .then(() => alert("Correo de recuperaci칩n enviado a " + email))
                .catch(err => alert(err.message));
        };

        document.getElementById('btn-logout').onclick = () => signOut(auth);

        // --- App Rendering ---
        function renderUI() {
            const menu = document.getElementById('nav-menu');
            const isAdmin = userProfile.role === 'admin';
            
            document.getElementById('user-display-name').innerText = userProfile.name;
            document.getElementById('user-display-role').innerText = isAdmin ? 'Administrador' : 'Solicitante';
            document.getElementById('user-avatar').innerText = userProfile.name[0].toUpperCase();

            const navItems = isAdmin ? [
                { id: 'dashboard', icon: 'fa-chart-pie', label: 'Dashboard' },
                { id: 'inventory', icon: 'fa-boxes', label: 'Inventario' },
                { id: 'orders', icon: 'fa-clipboard-list', label: 'Solicitudes' },
                { id: 'users', icon: 'fa-users', label: 'Usuarios' }
            ] : [
                { id: 'stock', icon: 'fa-shopping-cart', label: 'Suministros' },
                { id: 'my-orders', icon: 'fa-history', label: 'Mis Pedidos' }
            ];

            menu.innerHTML = navItems.map(item => `
                <div class="sidebar-item" onclick="loadTab('${item.id}')" id="nav-${item.id}">
                    <i class="fas ${item.icon} w-6"></i> ${item.label}
                </div>
            `).join('');

            loadTab(isAdmin ? 'dashboard' : 'stock');
        }

        window.loadTab = (id) => {
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(`nav-${id}`);
            if(activeNav) activeNav.classList.add('active');

            const area = document.getElementById('content-area');
            area.innerHTML = `<div class="animate-pulse text-slate-500">Cargando secci칩n...</div>`;

            switch(id) {
                case 'dashboard': renderDashboard(); break;
                case 'inventory': renderInventory(); break;
                case 'orders': renderOrders(); break;
                case 'stock': renderStock(); break;
                case 'my-orders': renderMyOrders(); break;
                case 'users': renderUsers(); break;
            }
        };

        // --- Tab Components ---
        
        async function renderDashboard() {
            const area = document.getElementById('content-area');
            area.innerHTML = `
                <h2 class="text-3xl font-bold mb-6">Vista General</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass p-6 rounded-xl">
                        <p class="text-slate-400 text-sm">Total Solicitudes</p>
                        <h3 class="text-4xl font-black mt-2" id="stat-orders">-</h3>
                    </div>
                    <div class="glass p-6 rounded-xl">
                        <p class="text-slate-400 text-sm">Suministros en Stock</p>
                        <h3 class="text-4xl font-black mt-2" id="stat-stock">-</h3>
                    </div>
                    <div class="glass p-6 rounded-xl">
                        <p class="text-slate-400 text-sm">Pendientes de Aprobaci칩n</p>
                        <h3 class="text-4xl font-black mt-2 text-yellow-500" id="stat-pending">-</h3>
                    </div>
                </div>
            `;
            // Cargar estad칤sticas reales
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), s => document.getElementById('stat-stock').innerText = s.size);
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), s => {
                document.getElementById('stat-orders').innerText = s.size;
                document.getElementById('stat-pending').innerText = s.docs.filter(d => d.data().status === 'pending').length;
            });
        }

        async function renderInventory() {
            const area = document.getElementById('content-area');
            area.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Gesti칩n de Inventario</h2>
                    <button onclick="openAddProduct()" class="btn-primary px-4 py-2 rounded-lg">+ Nuevo Producto</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="inventory-list"></div>
            `;
            
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), snap => {
                const list = document.getElementById('inventory-list');
                list.innerHTML = snap.docs.map(doc => {
                    const p = doc.data();
                    return `
                        <div class="glass p-4 rounded-xl flex items-center gap-4">
                            <div class="w-16 h-16 bg-slate-800 rounded flex items-center justify-center text-2xl">游닍</div>
                            <div class="flex-grow">
                                <p class="font-bold">${p.name}</p>
                                <p class="text-xs text-slate-400">Stock: ${p.qty}</p>
                            </div>
                            <button onclick="deleteProduct('${doc.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                }).join('');
            });
        }

        async function renderStock() {
            const area = document.getElementById('content-area');
            area.innerHTML = `
                <h2 class="text-3xl font-bold mb-6">Suministros Disponibles</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6" id="stock-grid"></div>
            `;

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), snap => {
                const grid = document.getElementById('stock-grid');
                grid.innerHTML = snap.docs.map(d => {
                    const p = d.data();
                    return `
                        <div class="glass rounded-2xl overflow-hidden hover:scale-[1.02] transition">
                            <div class="h-40 bg-slate-800 flex items-center justify-center text-4xl">游닍</div>
                            <div class="p-4">
                                <h3 class="font-bold text-lg">${p.name}</h3>
                                <p class="text-sm text-slate-400 mb-4">Stock actual: ${p.qty}</p>
                                <button onclick="requestItem('${d.id}', '${p.name}')" class="w-full btn-primary py-2 rounded-lg ${p.qty <= 0 ? 'opacity-50 pointer-events-none' : ''}">
                                    ${p.qty <= 0 ? 'Sin Stock' : 'Solicitar'}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        // --- Modals & Actions ---
        window.openAddProduct = () => {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-body').innerHTML = `
                <h3 class="text-2xl font-bold mb-6">Agregar Nuevo Suministro</h3>
                <div class="space-y-4">
                    <input id="new-p-name" placeholder="Nombre del producto" class="input-field">
                    <input id="new-p-qty" type="number" placeholder="Cantidad inicial" class="input-field">
                    <div class="flex gap-4">
                        <button onclick="document.getElementById('modal').classList.add('hidden')" class="w-full bg-slate-700 py-2 rounded-lg">Cancelar</button>
                        <button onclick="saveProduct()" class="w-full btn-primary py-2 rounded-lg shadow-lg">Guardar</button>
                    </div>
                </div>
            `;
        };

        window.saveProduct = async () => {
            const name = document.getElementById('new-p-name').value;
            const qty = parseInt(document.getElementById('new-p-qty').value);
            if(!name || isNaN(qty)) return alert("Datos inv치lidos");
            
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), { name, qty, createdAt: Date.now() });
            document.getElementById('modal').classList.add('hidden');
        };

        window.deleteProduct = async (id) => {
            if(confirm("쮼liminar este suministro del sistema?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id));
            }
        };

        window.requestItem = async (pid, name) => {
            const qty = prompt(`쮺u치ntas unidades de ${name} necesitas?`, "1");
            if(!qty || isNaN(qty) || qty <= 0) return;

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
                pid,
                productName: name,
                qty: parseInt(qty),
                uid: auth.currentUser.uid,
                userEmail: auth.currentUser.email,
                userName: userProfile.name,
                status: 'pending',
                date: Date.now()
            });
            alert("Solicitud enviada correctamente.");
        };

        async function renderOrders() {
            const area = document.getElementById('content-area');
            area.innerHTML = `<h2 class="text-3xl font-bold mb-6">Solicitudes de Suministros</h2><div class="space-y-4" id="orders-list"></div>`;
            
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderBy('date', 'desc')), snap => {
                document.getElementById('orders-list').innerHTML = snap.docs.map(d => {
                    const o = d.data();
                    const date = new Date(o.date).toLocaleDateString();
                    return `
                        <div class="glass p-6 rounded-xl flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <span class="status-badge ${o.status}">${o.status}</span>
                                <h4 class="text-xl font-bold mt-2">${o.productName} (x${o.qty})</h4>
                                <p class="text-sm text-slate-400">Solicitante: ${o.userName} (${o.userEmail})</p>
                                <p class="text-xs text-slate-500">${date}</p>
                            </div>
                            ${o.status === 'pending' ? `
                                <div class="flex gap-2 w-full md:w-auto">
                                    <button onclick="updateOrder('${d.id}', 'rejected')" class="bg-red-500/20 text-red-500 px-4 py-2 rounded-lg hover:bg-red-500 hover:text-white transition">Rechazar</button>
                                    <button onclick="updateOrder('${d.id}', 'approved', '${o.pid}', ${o.qty})" class="bg-green-500/20 text-green-500 px-4 py-2 rounded-lg hover:bg-green-500 hover:text-white transition">Aprobar</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            });
        }

        window.updateOrder = async (oid, status, pid, qty) => {
            if(status === 'approved') {
                const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', pid);
                const pSnap = await getDoc(pRef);
                if(pSnap.exists() && pSnap.data().qty >= qty) {
                    await updateDoc(pRef, { qty: pSnap.data().qty - qty });
                } else {
                    return alert("No hay suficiente stock para aprobar esta solicitud.");
                }
            }
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', oid), { status });
        };

        async function renderMyOrders() {
            const area = document.getElementById('content-area');
            area.innerHTML = `<h2 class="text-3xl font-bold mb-6">Mis Solicitudes</h2><div class="space-y-4" id="my-orders-list"></div>`;
            
            // Nota: En Firebase real filtrar칤amos por UID, aqu칤 traemos todo y filtramos en JS para evitar errores de 칤ndices.
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), snap => {
                const myDocs = snap.docs.filter(d => d.data().uid === auth.currentUser.uid);
                document.getElementById('my-orders-list').innerHTML = myDocs.map(d => {
                    const o = d.data();
                    return `
                        <div class="glass p-5 rounded-xl border-l-4 ${o.status === 'approved' ? 'border-green-500' : o.status === 'rejected' ? 'border-red-500' : 'border-yellow-500'}">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold">${o.productName}</h4>
                                    <p class="text-xs text-slate-400">Cantidad: ${o.qty}</p>
                                </div>
                                <span class="status-badge ${o.status}">${o.status}</span>
                            </div>
                        </div>
                    `;
                }).join('') || '<p class="text-slate-500">A칰n no has realizado solicitudes.</p>';
            });
        }

        async function renderUsers() {
            const area = document.getElementById('content-area');
            area.innerHTML = `<h2 class="text-3xl font-bold mb-6">Gesti칩n de Usuarios</h2><p class="text-slate-400 mb-4">Nota: Los usuarios se registran y aparecen aqu칤 al iniciar sesi칩n por primera vez.</p><div class="grid gap-4" id="users-list"></div>`;
            // Los perfiles privados no se pueden listar masivamente por seguridad en esta arquitectura.
            // Para un sistema real se usar칤a una colecci칩n 'public_profiles'
            area.innerHTML += `<div class="p-8 glass rounded-xl text-center text-slate-500">M칩dulo de gesti칩n de usuarios en desarrollo (Requiere Cloud Functions para listado completo seguro)</div>`;
        }

        // --- Bootstrap ---
        window.onload = () => {
            initAuth();
        }

    </script>
</body>
</html>