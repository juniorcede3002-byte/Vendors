<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Vendor | Sitio de Ventas</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- Iconos -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

<style>
body { font-family: Arial,sans-serif; background:#f2f2f2; padding:20px; }
.container { max-width:700px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
input, textarea, select, button { width:100%; padding:10px; margin-top:10px; border-radius:5px; border:1px solid #ccc; }
button { background:#111; color:#fff; border:none; cursor:pointer; transition:0.2s; }
button:hover { opacity:0.9; }
.role { background:#eee; }
.product { border:1px solid #ddd; padding:10px; margin-top:15px; border-radius:8px; display:flex; flex-direction:column; gap:5px; background:#fafafa; }
.product img, .product video { width:100%; border-radius:6px; }
.product h3 { margin:5px 0; }
.product p { margin:5px 0; }
.price { font-weight:bold; color:#111; }
.actions { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }
.actions button { flex:1; display:flex; align-items:center; justify-content:center; gap:5px; }
#cartList { background:#fff3cd; padding:10px; border-radius:8px; margin-top:15px; }
#ordersList { margin-top:20px; }
.status-pendiente { color:#ff9800; font-weight:bold; }
.status-revision { color:#2196f3; font-weight:bold; }
.status-verificado { color:#4caf50; font-weight:bold; }
.status-en-camino { color:#9c27b0; font-weight:bold; }
.status-finalizado { color:#000; font-weight:bold; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:8px; max-width:500px; width:90%; position:relative; }
.modal-content button.close { position:absolute; top:10px; right:10px; background:#f00; border:none; border-radius:50%; width:30px; height:30px; color:#fff; cursor:pointer; }
</style>
</head>

<body>
<div class="container">

<h2>Rol</h2>
<select id="role" class="role" onchange="toggleAdminFeatures(); loadProducts(); loadOrders(); loadUserOrders();">
  <option value="usuario">Usuario</option>
  <option value="admin">Admin</option>
</select>

<hr>

<div id="adminPanel">
<h2>Subir Producto</h2>
<input id="name" placeholder="Nombre">
<textarea id="description" placeholder="Descripción"></textarea>
<input id="price" type="number" placeholder="Precio">
<input id="media" type="file" accept="image/*,video/*">
<button onclick="uploadProduct()"><i class="fa fa-upload"></i> Subir</button>

<hr>
<h2>Solicitudes de Compra</h2>
<div id="ordersList"><i>No hay pedidos aún</i></div>
</div>

<hr>

<h2>Buscar</h2>
<input id="search" placeholder="Buscar por nombre" oninput="loadProducts()">
<input id="maxPrice" type="number" placeholder="Precio máximo" oninput="loadProducts()">

<hr>

<h2>Productos</h2>
<div id="productsList"></div>

<hr>
<h2><i class="fa fa-shopping-cart"></i> Carrito</h2>
<div id="cartList"><i>Carrito vacío</i></div>
<button onclick="viewCart()"><i class="fa fa-eye"></i> Ver Carrito</button>
<button onclick="openPurchaseForm()"><i class="fa fa-credit-card"></i> Comprar Carrito</button>
<button onclick="emptyCart()"><i class="fa fa-trash"></i> Vaciar Carrito</button>

<hr>
<h2>Historial de Compras</h2>
<div id="purchaseHistory"><i>No hay compras aún</i></div>

</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <button class="close" onclick="closeModal()">&times;</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
  authDomain: "proyectovendor.firebaseapp.com",
  projectId: "proyectovendor"
});
const db = firebase.firestore();
const CLOUD_NAME="df79cjklp";
const UPLOAD_PRESET="vendors_preset";

/* ELEMENTOS */
const roleSelect = document.getElementById("role");
const productsList = document.getElementById("productsList");
const adminPanel = document.getElementById("adminPanel");
const nameInput = document.getElementById("name");
const descriptionInput = document.getElementById("description");
const priceInput = document.getElementById("price");
const mediaInput = document.getElementById("media");
const cartListDiv = document.getElementById("cartList");
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modalBody");
const ordersListDiv = document.getElementById("ordersList");
const purchaseHistoryDiv = document.getElementById("purchaseHistory");

/* CARRITO EN LOCALSTORAGE */
let cart = JSON.parse(localStorage.getItem("cart")) || [];

/* PANEL ADMIN */
function toggleAdminFeatures(){
  adminPanel.style.display = roleSelect.value==="admin"?"block":"none";
}
toggleAdminFeatures();

/* SUBIR PRODUCTO */
async function uploadProduct(){
  const file = mediaInput.files[0];
  if(!file) return alert("Archivo requerido");
  if(!nameInput.value.trim() || !priceInput.value) return alert("Nombre y precio obligatorios");

  const form=new FormData();
  form.append("file",file);
  form.append("upload_preset",UPLOAD_PRESET);

  const isVideo=file.type.startsWith("video");
  const endpoint=isVideo?"video":"image";

  const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${endpoint}/upload`,{method:"POST",body:form});
  const data=await res.json();
  if(!data.secure_url) return alert("Error subir archivo");

  await db.collection("products").add({
    name:nameInput.value.trim(),
    description:descriptionInput.value.trim(),
    price:Number(priceInput.value),
    mediaUrl:data.secure_url,
    mediaType:isVideo?"video":"image",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Producto subido");
  nameInput.value=""; descriptionInput.value=""; priceInput.value=""; mediaInput.value="";
}

/* LISTAR PRODUCTOS */
function loadProducts(){
  const role = roleSelect.value;
  const search = document.getElementById("search").value.toLowerCase();
  const maxPrice = document.getElementById("maxPrice").value;

  db.collection("products").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    productsList.innerHTML="";
    snapshot.forEach(doc=>{
      const p = doc.data();
      if((search && !p.name.toLowerCase().includes(search)) || (maxPrice && p.price>maxPrice)) return;

      productsList.innerHTML+=`
        <div class="product">
          ${p.mediaType==="video"?`<video src="${p.mediaUrl}" controls></video>`:`<img src="${p.mediaUrl}">`}
          <h3>${p.name}</h3>
          <p>${p.description}</p>
          <b>$${p.price}</b>
          <div class="actions">
            <button onclick="showContact('${p.name}')"><i class="fa fa-phone"></i> Contactar</button>
            <button onclick="addToCart('${doc.id}','${p.name}',${p.price})"><i class="fa fa-cart-plus"></i> Añadir al carrito</button>
            ${role==="admin"?`
              <button onclick="editProduct('${doc.id}','${p.name}','${p.description}',${p.price})"><i class="fa fa-edit"></i> Editar</button>
              <button onclick="deleteProduct('${doc.id}')"><i class="fa fa-trash"></i> Eliminar</button>`:""}
          </div>
        </div>
      `;
    });
  });
}

/* EDITAR PRODUCTO */
function editProduct(id,name,desc,price){
  const newName = prompt("Nombre:",name);
  const newDesc = prompt("Descripción:",desc);
  const newPrice = prompt("Precio:",price);
  if(newName && newDesc && newPrice){
    db.collection("products").doc(id).update({
      name:newName,
      description:newDesc,
      price:Number(newPrice)
    });
    alert("Producto actualizado");
  }
}

/* ELIMINAR PRODUCTO */
function deleteProduct(id){
  if(confirm("¿Eliminar producto?")) db.collection("products").doc(id).delete();
}

/* CONTACTAR */
function showContact(name){
  openModal(`Contacta al vendedor sobre: <b>${name}</b><br>Número: 63892022`);
}

/* CARRITO */
function addToCart(id,name,price){
  cart.push({id,name,price});
  localStorage.setItem("cart",JSON.stringify(cart));
  showModalMessage(`${name} añadido al carrito`);
}

function emptyCart(){
  if(confirm("Vaciar carrito?")){
    cart=[];
    localStorage.setItem("cart",JSON.stringify(cart));
    cartListDiv.innerHTML="<i>Carrito vacío</i>";
  }
}

function viewCart(){
  if(cart.length===0){ cartListDiv.innerHTML="<i>Carrito vacío</i>"; return; }
  let html="<ul>";
  let total=0;
  cart.forEach(item=>{ html+=`<li>${item.name} - $${item.price}</li>`; total+=item.price; });
  html+=`</ul><b>Total: $${total}</b>`;
  cartListDiv.innerHTML=html;
}

/* FORMULARIO DE COMPRA CON COMPROBANTE */
function openPurchaseForm(){
  if(cart.length===0){ alert("Carrito vacío"); return; }
  let html=`<h3>Formulario de Compra</h3>
    <input id="buyerName" placeholder="Nombre">
    <input id="buyerPhone" placeholder="Teléfono/WhatsApp">
    <input id="buyerAddress" placeholder="Dirección de entrega">
    <input id="buyerEmail" placeholder="Email">
    <label>Adjuntar comprobante (opcional)</label>
    <input type="file" id="paymentProof" accept="image/*">
    <button onclick="confirmPurchase()">Confirmar Compra</button>`;
  openModal(html);
}

async function confirmPurchase(){
  const name = document.getElementById("buyerName").value.trim();
  const phone = document.getElementById("buyerPhone").value.trim();
  const address = document.getElementById("buyerAddress").value.trim();
  const email = document.getElementById("buyerEmail").value.trim();
  const proofFile = document.getElementById("paymentProof").files[0];

  if(!name || !phone || !address || !email){ alert("Todos los campos son obligatorios"); return; }

  let proofUrl = "";
  if(proofFile){
    const form = new FormData();
    form.append("file", proofFile);
    form.append("upload_preset",UPLOAD_PRESET);
    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:"POST",body:form});
    const data = await res.json();
    if(data.secure_url) proofUrl = data.secure_url;
  }

  await db.collection("orders").add({
    buyerName:name,
    buyerPhone:phone,
    buyerAddress:address,
    buyerEmail:email,
    products:cart,
    status:"Pendiente",
    proofUrl:proofUrl,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  cart=[];
  localStorage.setItem("cart",JSON.stringify(cart));
  cartListDiv.innerHTML="<i>Carrito vacío</i>";
  closeModal();
  alert("Compra registrada correctamente");
  loadOrders();
  loadUserOrders();
}

/* ADMIN: VER PEDIDOS Y CAMBIAR ESTADO */
function loadOrders(){
  if(roleSelect.value!=="admin"){ ordersListDiv.innerHTML="<i>Solo admin puede ver pedidos</i>"; return; }

  db.collection("orders").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    ordersListDiv.innerHTML="";
    snapshot.forEach(doc=>{
      const o=doc.data();
      const statusClass=getStatusClass(o.status);
      let html=`<div style="border:1px solid #ccc; padding:10px; margin:5px; border-radius:5px;">
        <b>Cliente:</b> ${o.buyerName} | <b>Tel:</b> ${o.buyerPhone} | <b>Email:</b> ${o.buyerEmail} <br>
        <b>Dirección:</b> ${o.buyerAddress} <br>
        <b>Productos:</b> ${o.products.map(p=>p.name+" ($"+p.price+")").join(", ")} <br>
        <b>Total:</b> $${o.products.reduce((a,b)=>a+b.price,0)} <br>
        ${o.proofUrl?`<b>Comprobante:</b><br><img src="${o.proofUrl}" width="150"><br>`:""}
        <b>Status:</b> <span class="${statusClass}">${o.status}</span><br>
        <select onchange="changeOrderStatus('${doc.id}',this.value)">
          <option value="Pendiente" ${o.status==="Pendiente"?"selected":""}>Pendiente</option>
          <option value="Revisión de pago" ${o.status==="Revisión de pago"?"selected":""}>Revisión de pago</option>
          <option value="Pago verificado" ${o.status==="Pago verificado"?"selected":""}>Pago verificado</option>
          <option value="En camino" ${o.status==="En camino"?"selected":""}>En camino</option>
          <option value="Finalizado" ${o.status==="Finalizado"?"selected":""}>Finalizado</option>
        </select>
      </div>`;
      ordersListDiv.innerHTML+=html;
    });
  });
}

function changeOrderStatus(id,status){
  db.collection("orders").doc(id).update({status:status});
}

/* HISTORIAL PARA USUARIO */
function loadUserOrders(){
  if(roleSelect.value!=="usuario"){ purchaseHistoryDiv.innerHTML="<i>Solo usuarios ven historial</i>"; return; }

  db.collection("orders").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    purchaseHistoryDiv.innerHTML="";
    if(snapshot.empty){ purchaseHistoryDiv.innerHTML="<i>No hay compras aún</i>"; return; }
    snapshot.forEach(doc=>{
      const o=doc.data();
      purchaseHistoryDiv.innerHTML+=`<div style="border:1px solid #ccc; padding:5px; margin:5px; border-radius:5px;">
        <b>Productos:</b> ${o.products.map(p=>p.name+" ($"+p.price+")").join(", ")}<br>
        <b>Total:</b> $${o.products.reduce((a,b)=>a+b.price,0)}<br>
        ${o.proofUrl?`<b>Comprobante:</b><br><img src="${o.proofUrl}" width="150"><br>`:""}
        <b>Status:</b> ${o.status}
      </div>`;
    });
  });
}

/* UTILS */
function getStatusClass(status){
  switch(status){
    case "Pendiente": return "status-pendiente";
    case "Revisión de pago": return "status-revision";
    case "Pago verificado": return "status-verificado";
    case "En camino": return "status-en-camino";
    case "Finalizado": return "status-finalizado";
    default: return "";
  }
}

function openModal(content){
  modalBody.innerHTML=content;
  modal.style.display="flex";
}
function closeModal(){ modal.style.display="none"; }
function showModalMessage(msg){ openModal(msg); setTimeout(closeModal,1500); }

loadProducts();
loadOrders();
loadUserOrders();
</script>
</body>
</html>
