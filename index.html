<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Vendor | Sistema Completo</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
header{background:#111;color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
header button{margin-left:5px}
nav{background:#222;padding:10px;display:none}
nav button{margin:5px}
.view{display:none;padding:20px}
.view.active{display:block}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:8px}
input,select,textarea,button{width:100%;padding:8px;margin:5px 0}
canvas{border:1px solid #000}
.status{font-weight:bold}
</style>
</head>

<body>

<header>
  <b>Vendor Dashboard</b>
  <div id="authBtns">
    <button onclick="showLogin()">Login</button>
    <button onclick="showRegister()">Registro</button>
    <button onclick="googleLogin()">Google</button>
  </div>
  <div id="userBar" style="display:none">
    <span id="userEmail"></span>
    <button onclick="openConfig()">⚙️</button>
    <button onclick="logout()">Salir</button>
  </div>
</header>

<nav id="nav">
  <button onclick="showView('products')">Productos</button>
  <button onclick="showView('cart')">Carrito</button>
  <button onclick="showView('orders')">Mis Compras</button>
  <button onclick="showView('admin')" id="adminBtn" style="display:none">Admin</button>
</nav>

<!-- LOGIN -->
<div id="login" class="view active"></div>

<!-- PRODUCTS -->
<div id="products" class="view">
  <h2>Productos</h2>
  <div id="productsList"></div>
</div>

<!-- CART -->
<div id="cart" class="view">
  <h2>Carrito</h2>
  <div id="cartList"></div>

  <h3>Finalizar compra</h3>
  <input id="cName" placeholder="Nombre completo">
  <input id="cPhone" placeholder="Teléfono">
  <input id="cAddress" placeholder="Dirección">

  <select id="cPayment" onchange="paymentInfo()">
    <option value="">Método de pago</option>
    <option value="yappy">Yappy</option>
    <option value="ach">ACH</option>
    <option value="efectivo">Efectivo</option>
  </select>

  <div id="paymentText"></div>

  <input type="file" id="paymentProof">
  <button onclick="finalizeOrder()">Confirmar Pedido</button>
</div>

<!-- USER ORDERS -->
<div id="orders" class="view">
  <h2>Historial de pedidos</h2>
  <div id="ordersList"></div>
</div>

<!-- ADMIN -->
<div id="admin" class="view">
  <h2>Panel Admin</h2>

  <h3>Subir producto</h3>
  <input id="pName" placeholder="Nombre">
  <input id="pPrice" type="number" placeholder="Precio">
  <input type="file" id="pFile">
  <button onclick="uploadProduct()">Subir</button>

  <h3>Pedidos</h3>
  <div id="adminOrders"></div>
</div>

<!-- MODAL -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6)">
  <div style="background:#fff;padding:20px;margin:50px auto;max-width:400px">
    <div id="modalBody"></div>
    <button onclick="closeModal()">Cerrar</button>
  </div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
  authDomain: "proyectovendor.firebaseapp.com",
  projectId: "proyectovendor",
  storageBucket: "proyectovendor.firebasestorage.app",
  messagingSenderId: "1038115164902",
  appId: "1:1038115164902:web:3d72bd44f3e5da487c2127"
});

const auth = firebase.auth();
const db = firebase.firestore();
const provider = new firebase.auth.GoogleAuthProvider();

/* ================= CLOUDINARY ================= */
const CLOUD_NAME = "df79cjklp";
const UPLOAD_PRESET = "vendors_preset";
const CLOUD_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;

/* ================= GLOBAL ================= */
let user=null;
let role="user";
let cart=[];

/* ================= AUTH ================= */
auth.onAuthStateChanged(async u=>{
  if(u){
    user=u;
    userEmail.innerText=u.email;
    authBtns.style.display="none";
    userBar.style.display="block";
    nav.style.display="block";

    const ref=db.collection("users").doc(u.uid);
    const snap=await ref.get();
    if(!snap.exists) await ref.set({email:u.email,role:"user"});
    role=(await ref.get()).data().role;
    if(role==="admin") adminBtn.style.display="inline-block";

    loadProducts(); loadOrders(); loadAdminOrders();
    showView("products");
  }else{
    nav.style.display="none";
    authBtns.style.display="block";
    userBar.style.display="none";
    showLogin();
  }
});

function showLogin(){
  login.innerHTML=`
  <h2>Login</h2>
  <input id="lEmail" placeholder="Email">
  <input id="lPass" type="password" placeholder="Contraseña">
  <button onclick="loginUser()">Entrar</button>`;
  showView("login");
}
function showRegister(){
  login.innerHTML=`
  <h2>Registro</h2>
  <input id="rEmail" placeholder="Email">
  <input id="rPass" type="password" placeholder="Contraseña">
  <button onclick="registerUser()">Crear cuenta</button>`;
  showView("login");
}
function loginUser(){auth.signInWithEmailAndPassword(lEmail.value,lPass.value);}
function registerUser(){auth.createUserWithEmailAndPassword(rEmail.value,rPass.value);}
function googleLogin(){auth.signInWithPopup(provider);}
function logout(){auth.signOut();}

/* ================= NAV ================= */
function showView(id){
 document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}

/* ================= PRODUCTS ================= */
function loadProducts(){
 db.collection("products").onSnapshot(s=>{
  productsList.innerHTML="";
  s.forEach(d=>{
   const p=d.data();
   productsList.innerHTML+=`
   <div class="card">
     <b>${p.name}</b><br>$${p.price}
     <button onclick="addToCart('${d.id}',${p.price})">Añadir</button>
   </div>`;
  });
 });
}
function addToCart(id,price){
 cart.push({id,price});
 renderCart();
}
function renderCart(){
 cartList.innerHTML="";
 let total=0;
 cart.forEach(i=>{total+=i.price;cartList.innerHTML+=`<div>$${i.price}</div>`});
 cartList.innerHTML+=`<b>Total: $${total}</b>`;
}

/* ================= PAYMENT ================= */
function paymentInfo(){
 if(cPayment.value==="yappy") paymentText.innerHTML="Yappy → +507 63892022 Emanuel Cedeño";
 if(cPayment.value==="ach") paymentText.innerHTML="ACH → Banco General 0454966165208";
 if(cPayment.value==="efectivo") paymentText.innerHTML="Efectivo al recibir";
}

/* ================= ORDER ================= */
async function finalizeOrder(){
 const order={
  user:user.uid,
  name:cName.value,
  phone:cPhone.value,
  address:cAddress.value,
  payment:cPayment.value,
  items:cart,
  status:"pendiente",
  created:new Date()
 };
 await db.collection("orders").add(order);
 cart=[];
 alert("Pedido enviado");
 showView("orders");
}

/* ================= USER ORDERS ================= */
function loadOrders(){
 db.collection("orders").where("user","==",user.uid).onSnapshot(s=>{
  ordersList.innerHTML="";
  s.forEach(d=>{
   const o=d.data();
   ordersList.innerHTML+=`<div class="card">Estado: ${o.status}</div>`;
  });
 });
}

/* ================= ADMIN ================= */
function loadAdminOrders(){
 if(role!=="admin") return;
 db.collection("orders").onSnapshot(s=>{
  adminOrders.innerHTML="";
  s.forEach(d=>{
   const o=d.data();
   adminOrders.innerHTML+=`
   <div class="card">
     ${o.name}
     <select onchange="db.collection('orders').doc('${d.id}').update({status:this.value})">
       <option>pendiente</option>
       <option>pago verificado</option>
       <option>en camino</option>
       <option>entregado</option>
     </select>
   </div>`;
  });
 });
}

/* ================= UPLOAD PRODUCT ================= */
async function uploadProduct(){
 const data=new FormData();
 data.append("file",pFile.files[0]);
 data.append("upload_preset",UPLOAD_PRESET);
 const res=await fetch(CLOUD_URL,{method:"POST",body:data});
 const json=await res.json();
 await db.collection("products").add({name:pName.value,price:+pPrice.value,media:json.secure_url});
 alert("Producto subido");
}
</script>
</body>
</html>