<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Vendor | Dashboard Final</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

<style>
body { font-family: Arial,sans-serif; background:#f2f2f2; margin:0; padding:0; }
header { background:#111; color:#fff; padding:15px; text-align:center; font-size:20px; }
.container { max-width:1000px; margin:auto; padding:20px; }
.tabs { display:flex; gap:5px; margin-bottom:15px; flex-wrap:wrap; }
.tabs button { flex:1; padding:10px; cursor:pointer; border:none; border-radius:5px; background:#ddd; transition:0.2s; }
.tabs button.active { background:#111; color:#fff; }
.tab-content { display:none; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.tab-content.active { display:block; }
.product, .order { border:1px solid #ddd; padding:10px; margin-top:15px; border-radius:8px; background:#fafafa; }
.actions { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }
.actions button { flex:1; display:flex; align-items:center; justify-content:center; gap:5px; }
.status-pendiente { color:#ff9800; font-weight:bold; }
.status-revision { color:#2196f3; font-weight:bold; }
.status-verificado { color:#4caf50; font-weight:bold; }
.status-en-camino { color:#9c27b0; font-weight:bold; }
.status-finalizado { color:#000; font-weight:bold; }
.status-cancelada { color:#f44336; font-weight:bold; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;}
.modal-content { background:#fff; padding:20px; border-radius:8px; max-width:500px; width:90%; position:relative; box-shadow:0 2px 15px rgba(0,0,0,0.3); }
.modal-content button.close { position:absolute; top:10px; right:10px; background:#f00; border:none; border-radius:50%; width:30px; height:30px; color:#fff; cursor:pointer; font-weight:bold; font-size:16px; }
input, textarea, select, button { width:100%; padding:10px; margin-top:10px; border-radius:5px; border:1px solid #ccc; }
button { background:#111; color:#fff; border:none; cursor:pointer; transition:0.2s; }
button:hover { opacity:0.9; }
</style>
</head>
<body>

<header>Vendor Dashboard Final</header>

<div class="container">
  <div>
    Rol: 
    <select id="role">
      <option value="usuario">Usuario</option>
      <option value="admin">Admin</option>
    </select>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="productsTab">Productos</button>
    <button class="tab-btn" data-tab="cartTab">Carrito</button>
    <button class="tab-btn" data-tab="ordersTab">Compras</button>
    <button class="tab-btn" data-tab="adminTab">Admin</button>
  </div>

  <!-- TAB Productos -->
  <div id="productsTab" class="tab-content active">
    <h2>Productos</h2>
    <input id="search" placeholder="Buscar por nombre">
    <input id="maxPrice" type="number" placeholder="Precio máximo">
    <div id="productsList"></div>
  </div>

  <!-- TAB Carrito -->
  <div id="cartTab" class="tab-content">
    <h2>Carrito</h2>
    <div id="cartList"><i>Carrito vacío</i></div>
    <button onclick="viewCart()"><i class="fa fa-eye"></i> Ver Carrito</button>
    <button onclick="openPurchaseForm()"><i class="fa fa-credit-card"></i> Comprar Carrito</button>
    <button onclick="emptyCart()"><i class="fa fa-trash"></i> Vaciar Carrito</button>
  </div>

  <!-- TAB Historial -->
  <div id="ordersTab" class="tab-content">
    <h2>Historial de Compras</h2>
    <div id="purchaseHistory"></div>
  </div>

  <!-- TAB Admin -->
  <div id="adminTab" class="tab-content">
    <div id="adminPanel">
      <h3>Subir Producto</h3>
      <input id="name" placeholder="Nombre">
      <textarea id="description" placeholder="Descripción"></textarea>
      <input id="price" type="number" placeholder="Precio">
      <input id="media" type="file" accept="image/*,video/*">
      <button onclick="uploadProduct()"><i class="fa fa-upload"></i> Subir</button>

      <h3>Solicitudes de Compra</h3>
      <div id="ordersList"></div>
    </div>
  </div>

</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <button class="close" onclick="closeModal()">&times;</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
  authDomain: "proyectovendor.firebaseapp.com",
  projectId: "proyectovendor"
});
const db = firebase.firestore();
const CLOUD_NAME="df79cjklp";
const UPLOAD_PRESET="vendors_preset";

let role="usuario";
let cart = JSON.parse(localStorage.getItem("cart")) || [];

const productsList = document.getElementById("productsList");
const cartListDiv = document.getElementById("cartList");
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modalBody");
const ordersListDiv = document.getElementById("ordersList");
const purchaseHistoryDiv = document.getElementById("purchaseHistory");
const adminPanel = document.getElementById("adminPanel");
const nameInput = document.getElementById("name");
const descriptionInput = document.getElementById("description");
const priceInput = document.getElementById("price");
const mediaInput = document.getElementById("media");

// --- Roles ---
document.getElementById("role").addEventListener("change", setRole);
function setRole(){ 
    role=document.getElementById("role").value; 
    toggleAdmin(); 
    loadProducts(); 
    loadOrders(); 
    loadUserOrders(); 
}
function toggleAdmin(){ 
  if(role==="admin"){
    adminPanel.style.display="block"; 
    document.querySelector("[data-tab='adminTab']").style.display="inline-block";
  } else { 
    adminPanel.style.display="none"; 
    document.querySelector("[data-tab='adminTab']").style.display="none";
  }
}

// --- Tabs ---
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".tab-content").forEach(tab=>tab.classList.remove("active"));
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

// --- Modal ---
function openModal(content){ modal.style.display="flex"; modalBody.innerHTML=content; }
function closeModal(){ modal.style.display="none"; }
function showModalMessage(msg){ openModal(`<p>${msg}</p>`); setTimeout(closeModal,1500); }

// --- Productos ---
async function uploadProduct(){
  const file = mediaInput.files[0];
  if(!file) return alert("Archivo requerido");
  if(!nameInput.value.trim() || !priceInput.value) return alert("Nombre y precio obligatorios");
  const form=new FormData();
  form.append("file",file);
  form.append("upload_preset",UPLOAD_PRESET);
  const isVideo=file.type.startsWith("video");
  const endpoint=isVideo?"video":"image";
  const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${endpoint}/upload`,{method:"POST",body:form});
  const data=await res.json();
  if(!data.secure_url) return alert("Error subir archivo");
  await db.collection("products").add({
    name:nameInput.value.trim(),
    description:descriptionInput.value.trim(),
    price:Number(priceInput.value),
    mediaUrl:data.secure_url,
    mediaType:isVideo?"video":"image",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("Producto subido");
  nameInput.value=""; descriptionInput.value=""; priceInput.value=""; mediaInput.value="";
}

function loadProducts(){
  const search = document.getElementById("search").value.toLowerCase();
  const maxPrice = document.getElementById("maxPrice").value;
  db.collection("products").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    productsList.innerHTML="";
    snapshot.forEach(doc=>{
      const p=doc.data();
      if((search && !p.name.toLowerCase().includes(search)) || (maxPrice && p.price>maxPrice)) return;
      productsList.innerHTML+=`
        <div class="product">
          ${p.mediaType==="video"?`<video src="${p.mediaUrl}" controls></video>`:`<img src="${p.mediaUrl}">`}
          <h3>${p.name}</h3>
          <p>${p.description}</p>
          <b>$${p.price}</b>
          <div class="actions">
            <button onclick="showContact('${p.name}')"><i class="fa fa-phone"></i> Contactar</button>
            <button onclick="addToCart('${doc.id}','${p.name}',${p.price})"><i class="fa fa-cart-plus"></i> Añadir al carrito</button>
            ${role==="admin"?`
              <button onclick="editProduct('${doc.id}','${p.name}','${p.description}',${p.price})"><i class="fa fa-edit"></i> Editar</button>
              <button onclick="deleteProduct('${doc.id}')"><i class="fa fa-trash"></i> Eliminar</button>`:""}
          </div>
        </div>
      `;
    });
  });
}

// --- Carrito ---
function addToCart(id,name,price){ cart.push({id,name,price}); localStorage.setItem("cart",JSON.stringify(cart)); showModalMessage(`${name} añadido al carrito`); }
function emptyCart(){ if(confirm("Vaciar carrito?")){ cart=[]; localStorage.setItem("cart",JSON.stringify(cart)); cartListDiv.innerHTML="<i>Carrito vacío</i>"; } }
function viewCart(){ if(cart.length===0){ cartListDiv.innerHTML="<i>Carrito vacío</i>"; return; } let html="<ul>"; let total=0; cart.forEach(item=>{ html+=`<li>${item.name} - $${item.price}</li>`; total+=item.price; }); html+=`</ul><b>Total: $${total}</b>`; cartListDiv.innerHTML=html; }

// --- Contactar ---
function showContact(name){ openModal(`Contacta al vendedor sobre: <b>${name}</b><br>Número: 63892022`); }

// --- Editar / Eliminar ---
function editProduct(id,name,desc,price){ const n=prompt("Nombre:",name); const d=prompt("Descripción:",desc); const p=prompt("Precio:",price); if(n && d && p) db.collection("products").doc(id).update({name:n,description:d,price:Number(p)}); }
function deleteProduct(id){ if(confirm("Eliminar producto?")) db.collection("products").doc(id).delete(); }

// --- Compras ---
function openPurchaseForm(){
  if(cart.length===0){ alert("Carrito vacío"); return; }
  let html=`<h3>Formulario de Compra</h3>
    <input id="buyerName" placeholder="Nombre">
    <input id="buyerPhone" placeholder="Teléfono/WhatsApp">
    <input id="buyerAddress" placeholder="Dirección de entrega">
    <input id="buyerEmail" placeholder="Email">
    <label>Adjuntar comprobante (opcional)</label>
    <input type="file" id="paymentProof" accept="image/*">
    <button onclick="confirmPurchase()">Confirmar Compra</button>`;
  openModal(html);
}

async function confirmPurchase(){
  const name=document.getElementById("buyerName").value.trim();
  const phone=document.getElementById("buyerPhone").value.trim();
  const address=document.getElementById("buyerAddress").value.trim();
  const email=document.getElementById("buyerEmail").value.trim();
  const proofFile=document.getElementById("paymentProof").files[0];
  if(!name||!phone||!address||!email) return alert("Todos los campos obligatorios");
  let proofUrl="";
  if(proofFile){
    const form=new FormData(); form.append("file",proofFile); form.append("upload_preset",UPLOAD_PRESET);
    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:"POST",body:form});
    const data=await res.json(); proofUrl=data.secure_url;
  }
  await db.collection("orders").add({
    buyerName:name,
    buyerPhone:phone,
    buyerAddress:address,
    buyerEmail:email,
    products:cart,
    status:"pendiente",
    proof:proofUrl||"",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  cart=[]; localStorage.setItem("cart",JSON.stringify(cart)); closeModal();
  showModalMessage("Compra enviada correctamente");
  loadOrders(); loadUserOrders();
}

// --- Ordenes Admin ---
function loadOrders(){
  if(role!=="admin"){ ordersListDiv.innerHTML="<i>No tienes acceso</i>"; return; }
  db.collection("orders").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    ordersListDiv.innerHTML="";
    snapshot.forEach(doc=>{
      const o=doc.data();
      let proofBtn=o.proof?`<button onclick="viewProof('${o.proof}')">Ver comprobante</button>`:"";
      let addProofBtn=`<button onclick="uploadOrderProof('${doc.id}')">Agregar / Cambiar comprobante</button>`;
      let statusOptions=["pendiente","revision","verificado","en-camino","finalizado","cancelada"];
      let statusSelect=`<select onchange="changeStatus('${doc.id}',this.value)">${statusOptions.map(s=>`<option value="${s}" ${o.status===s?'selected':''}>${s}</option>`).join('')}</select>`;
      ordersListDiv.innerHTML+=`<div class="order"><h4>${o.buyerName} - ${o.buyerPhone}</h4><p>${o.buyerAddress} - ${o.buyerEmail}</p><b>${o.products.map(p=>p.name+" $"+p.price).join(", ")}</b><p class="status-${o.status}">Estado: ${o.status}</p>${proofBtn} ${addProofBtn}<br>Cambiar Estado: ${statusSelect}<button onclick="cancelOrder('${doc.id}')">Cancelar Compra</button></div>`;
    });
  });
}

// --- Historial Usuario ---
function loadUserOrders(){
  db.collection("orders").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    purchaseHistoryDiv.innerHTML="";
    snapshot.forEach(doc=>{
      const o=doc.data();
      let addProofBtn=o.status!=="finalizado"?`<button onclick="uploadOrderProof('${doc.id}')">Agregar / Cambiar comprobante</button>`:"";
      purchaseHistoryDiv.innerHTML+=`<div class="order"><b>${o.products.map(p=>p.name+" $"+p.price).join(", ")}</b><p class="status-${o.status}">Estado: ${o.status}</p>${o.proof?`<button onclick="viewProof('${o.proof}')">Ver comprobante</button>`:""} ${addProofBtn}</div>`;
    });
  });
}

// --- Subir comprobante ---
async function uploadOrderProof(orderId){
  const input=document.createElement("input"); input.type="file"; input.accept="image/*";
  input.onchange=async ()=>{
    const file=input.files[0]; if(!file) return;
    const form=new FormData(); form.append("file",file); form.append("upload_preset",UPLOAD_PRESET);
    const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:"POST",body:form});
    const data=await res.json();
    await db.collection("orders").doc(orderId).update({proof:data.secure_url});
    showModalMessage("Comprobante subido");
  };
  input.click();
}

// --- Cambiar estado ---
function changeStatus(id,newStatus){ if(confirm(`Confirmar cambio a "${newStatus}"?`)) db.collection("orders").doc(id).update({status:newStatus}); }

// --- Cancelar orden ---
function cancelOrder(id){ const reason=prompt("Motivo de cancelación:"); if(reason) db.collection("orders").doc(id).update({status:"cancelada",cancelReason:reason}); }

// --- Ver comprobante ---
function viewProof(url){ openModal(`<img src="${url}" style="width:100%;">`); }

// --- Inicializar ---
setRole();
loadProducts();
loadOrders();
loadUserOrders();
</script>
</body>
</html>
