<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Vendor | Dashboard Integrado</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
body { font-family: Arial,sans-serif; background:#f2f2f2; margin:0; padding:0; }
header { background:#111; color:#fff; padding:15px; display:flex; justify-content:space-between; align-items:center; position:fixed; top:0; width:100%; z-index:100; }
header button { background:#fff; color:#111; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; }
.container { max-width:1000px; margin:auto; padding:100px 20px 20px; display:none; }
.tabs { display:flex; gap:5px; margin-bottom:15px; flex-wrap:wrap; }
.tabs button { flex:1; padding:10px; cursor:pointer; border:none; border-radius:5px; background:#ddd; transition:0.2s; }
.tabs button.active { background:#111; color:#fff; }
.tab-content { display:none; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.tab-content.active { display:block; }
input, textarea, select, button { width:100%; padding:10px; margin-top:10px; border-radius:5px; border:1px solid #ccc; }
button { background:#111; color:#fff; border:none; cursor:pointer; transition:0.2s; }
button:hover { opacity:0.9; }
.product, .order { border:1px solid #ddd; padding:10px; margin-top:15px; border-radius:8px; background:#fafafa; }
.actions { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }
.actions button { flex:1; display:flex; align-items:center; justify-content:center; gap:5px; }
.status-pendiente { color:#ff9800; font-weight:bold; }
.status-revision\ de\ pago { color:#2196f3; font-weight:bold; }
.status-pago\ verificado { color:#4caf50; font-weight:bold; }
.status-en\ camino { color:#9c27b0; font-weight:bold; }
.status-entregado { color:#000; font-weight:bold; }
.status-cancelada { color:#f44336; font-weight:bold; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;}
.modal-content { background:#fff; padding:20px; border-radius:8px; max-width:500px; width:90%; position:relative; box-shadow:0 2px 15px rgba(0,0,0,0.3); max-height:90%; overflow:auto; }
.modal-content button.close { position:absolute; top:10px; right:10px; background:#f00; border:none; border-radius:50%; width:30px; height:30px; color:#fff; cursor:pointer; font-weight:bold; font-size:16px; }
.stats { margin-top:10px; padding:10px; background:#eee; border-radius:5px; }
.stats div { margin-bottom:5px; }
.paymentInfo { margin-top:10px; padding:10px; background:#f0f0f0; border-radius:5px; }
</style>
</head>
<body>

<header>
  Vendor Dashboard
  <div id="authButtons">
    <button onclick="showLoginForm()">Iniciar Sesión</button>
    <button onclick="showRegisterForm()">Crear Cuenta</button>
    <button onclick="loginWithGoogle()">Google</button>
  </div>
  <div id="userInfo" style="display:none;">
    <span id="userEmail"></span>
    <button onclick="logout()">Cerrar Sesión</button>
    <button onclick="openConfig()">Configuración</button>
  </div>
</header>

<div class="container" id="dashboard">
  <div class="tabs">
    <button class="tab-btn active" data-tab="productsTab">Productos</button>
    <button class="tab-btn" data-tab="cartTab">Carrito</button>
    <button class="tab-btn" data-tab="ordersTab">Compras</button>
    <button class="tab-btn" data-tab="adminTab">Admin</button>
  </div>

  <div id="productsTab" class="tab-content active">
    <h2>Productos</h2>
    <input id="search" placeholder="Buscar por nombre" oninput="filterProducts()">
    <input id="maxPrice" type="number" placeholder="Precio máximo" oninput="filterProducts()">
    <div id="productsList"></div>
  </div>

  <div id="cartTab" class="tab-content">
    <h2>Carrito</h2>
    <div id="cartList"><i>Carrito vacío</i></div>
    <button onclick="viewCart()">Ver Carrito</button>
    <button onclick="openPurchaseForm()">Comprar Carrito</button>
    <button onclick="emptyCart()">Vaciar Carrito</button>
  </div>

  <div id="ordersTab" class="tab-content">
    <h2>Historial de Compras</h2>
    <div id="purchaseHistory"></div>
  </div>

  <div id="adminTab" class="tab-content">
    <div id="adminPanel">
      <h3>Subir Producto</h3>
      <input id="name" placeholder="Nombre">
      <textarea id="description" placeholder="Descripción"></textarea>
      <input id="price" type="number" placeholder="Precio">
      <input id="media" type="file" accept="image/*,video/*">
      <button onclick="uploadProduct()">Subir</button>

      <h3>Solicitudes de Compra</h3>
      <div class="stats" id="orderStats"></div>
      <div id="ordersList"></div>
    </div>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <button class="close" onclick="closeModal()">&times;</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
  authDomain: "proyectovendor.firebaseapp.com",
  projectId: "proyectovendor"
});
const db = firebase.firestore();
const auth = firebase.auth();
const provider = new firebase.auth.GoogleAuthProvider();
let cart = JSON.parse(localStorage.getItem("cart")) || [];
let role = "usuario";

// --- Modal ---
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modalBody");
function openModal(content){ modal.style.display="flex"; modalBody.innerHTML=content; }
function closeModal(){ modal.style.display="none"; }
function showModalMessage(msg){ openModal(`<p>${msg}</p>`); setTimeout(closeModal,1500); }

// --- Auth ---
function showLoginForm(){ openModal(`<h3>Iniciar Sesión</h3>
<input id="loginEmail" placeholder="Email">
<input id="loginPass" placeholder="Contraseña" type="password">
<button onclick="login()">Entrar</button>
<button onclick="showResetPass()">Olvidé mi contraseña</button>
<button onclick="loginWithGoogle()">Iniciar con Google</button>`);}
function showRegisterForm(){ openModal(`<h3>Crear Cuenta</h3>
<input id="regEmail" placeholder="Email">
<input id="regPass" placeholder="Contraseña" type="password">
<button onclick="register()">Registrar</button>
<button onclick="loginWithGoogle()">Registrar con Google</button>`);}
function showResetPass(){ const email = prompt("Ingrese su correo:"); if(email) auth.sendPasswordResetEmail(email).then(()=>alert("Correo enviado")).catch(e=>alert(e.message)); }
function login(){ const email=document.getElementById("loginEmail").value; const pass=document.getElementById("loginPass").value; auth.signInWithEmailAndPassword(email,pass).then(u=>{ closeModal(); initUser(u.user); }).catch(e=>alert(e.message)); }
function register(){ const email=document.getElementById("regEmail").value; const pass=document.getElementById("regPass").value; auth.createUserWithEmailAndPassword(email,pass).then(u=>{ closeModal(); initUser(u.user); }).catch(e=>alert(e.message)); }
function loginWithGoogle(){ auth.signInWithPopup(provider).then(result=>{ closeModal(); initUser(result.user); }).catch(e=>alert(e.message)); }
function logout(){ auth.signOut().then(()=>location.reload()); }

// --- Init User ---
async function initUser(user){
  document.getElementById("authButtons").style.display="none";
  document.getElementById("userInfo").style.display="inline-block";
  document.getElementById("userEmail").innerText=user.email;
  const docRef = db.collection("users").doc(user.uid);
  const docSnap = await docRef.get();
  if(!docSnap.exists) await docRef.set({pais:'',residencia:'',name:user.displayName||'',email:user.email});
  role = (user.email==="admin@vendors.com") ? "admin" : "usuario";
  document.getElementById("dashboard").style.display="block";
  toggleAdmin(); setUpTabs(); loadProducts(); loadOrders(); loadUserOrders(); renderCart();
}

// --- Configuración ---
async function openConfig(){
  const user = auth.currentUser;
  const docSnap = await db.collection("users").doc(user.uid).get();
  const data = docSnap.data();
  openModal(`<h3>Configuración</h3>
    <input id="configName" placeholder="Nombre" value="${data.name||''}">
    <input id="configEmail" placeholder="Email" value="${data.email||''}">
    <input id="configCountry" placeholder="País" value="${data.pais||''}">
    <input id="configResidence" placeholder="Residencia" value="${data.residencia||''}">
    <input id="configPass" placeholder="Nueva contraseña" type="password">
    <button onclick="updateConfig()">Guardar</button>`);
}
async function updateConfig(){
  const user = auth.currentUser;
  const name=document.getElementById("configName").value;
  const email=document.getElementById("configEmail").value;
  const pais=document.getElementById("configCountry").value;
  const residencia=document.getElementById("configResidence").value;
  const pass=document.getElementById("configPass").value;
  await db.collection("users").doc(user.uid).update({name,email,pais,residencia});
  if(name) user.updateProfile({displayName:name});
  if(email) user.updateEmail(email).catch(e=>alert(e.message));
  if(pass) user.updatePassword(pass).catch(e=>alert(e.message));
  showModalMessage("Configuración actualizada");
  closeModal();
}

// --- Tabs ---
function setUpTabs(){ document.querySelectorAll(".tab-btn").forEach(btn=>{ btn.addEventListener("click",()=>{ document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); document.querySelectorAll(".tab-content").forEach(tab=>tab.classList.remove("active")); document.getElementById(btn.dataset.tab).classList.add("active"); }); }); }
function toggleAdmin(){ if(role==="admin"){ document.getElementById("adminPanel").style.display="block"; document.querySelector("[data-tab='adminTab']").style.display="inline-block"; } else { document.getElementById("adminPanel").style.display="none"; document.querySelector("[data-tab='adminTab']").style.display="none"; } }

// --- Productos ---
async function loadProducts(){ const productsList=document.getElementById("productsList"); productsList.innerHTML="Cargando..."; db.collection("products").onSnapshot(snapshot=>{ let html=""; snapshot.forEach(doc=>{ const p=doc.data(); html+=`<div class="product"><strong>${p.name}</strong> - $${p.price}<br>${p.description}<br>${p.media?`<img src="${p.media}" width="150">`:""}<div class="actions"><button onclick="addToCart('${doc.id}','${p.name}',${p.price},'${p.media||''}')"><i class="fa fa-cart-plus"></i> Añadir al carrito</button>${role==='admin'?`<button onclick="editProductForm('${doc.id}')"><i class="fa fa-edit"></i> Editar</button><button onclick="deleteProduct('${doc.id}')"><i class="fa fa-trash"></i> Eliminar</button>`:""}</div></div>`;}); productsList.innerHTML=html||"<i>No hay productos</i>"; });}

// --- Carrito ---
function addToCart(id,name,price,media){ cart.push({id,name,price,media}); localStorage.setItem("cart",JSON.stringify(cart)); renderCart(); showModalMessage("Añadido al carrito"); }
function renderCart(){ const list=document.getElementById("cartList"); if(cart.length===0){ list.innerHTML="<i>Carrito vacío</i>"; return; } let html=""; cart.forEach((p,i)=> html+=`<div>${p.name} - $${p.price} <button onclick="removeFromCart(${i})">Eliminar</button></div>`); list.innerHTML=html; }
function removeFromCart(index){ cart.splice(index,1); localStorage.setItem("cart",JSON.stringify(cart)); renderCart(); }
function emptyCart(){ if(confirm("Vaciar carrito?")){cart=[]; localStorage.setItem("cart","[]"); renderCart();} }
function viewCart(){ renderCart(); showModalMessage("Carrito actualizado"); }

// --- Compra ajustada ---
function openPurchaseForm(){ if(cart.length===0) return alert("Carrito vacío"); openModal(`
<h3>Formulario de Compra</h3>
<input id="buyerName" placeholder="Nombre completo">
<input id="buyerPhone" placeholder="Teléfono">
<input id="buyerWhats" placeholder="WhatsApp">
<input id="buyerAddress" placeholder="Dirección">
<input id="buyerEmail" placeholder="Email">
<select id="buyerPayment" onchange="showPaymentInfo()">
<option value="yappy">Yappy</option>
<option value="ach">ACH</option>
</select>
<div class="paymentInfo" id="paymentInfo"></div>
<input id="buyerComprobante" type="file" accept="image/*">
<button onclick="submitPurchase()">Enviar Compra</button>
`); showPaymentInfo(); }

function showPaymentInfo(){
  const method=document.getElementById("buyerPayment").value;
  const info=document.getElementById("paymentInfo");
  if(method==="yappy"){ info.innerHTML="+507 63892022 Emanuel Cedeño"; }
  else if(method==="ach"){ info.innerHTML="EMANUEL CLEMENTE CEDEÑO MORAN - Banco General - Cuenta de ahorros - 0454966165208"; }
  else{ info.innerHTML=""; }
}

// --- Enviar compra ---
async function submitPurchase(){
  const name=document.getElementById("buyerName").value.trim();
  const phone=document.getElementById("buyerPhone").value.trim();
  const whatsapp=document.getElementById("buyerWhats").value.trim();
  const address=document.getElementById("buyerAddress").value.trim();
  const email=document.getElementById("buyerEmail").value.trim();
  const payment=document.getElementById("buyerPayment").value;
  const comprobanteFile=document.getElementById("buyerComprobante").files[0];
  if(!name||!phone||!whatsapp||!address||!email||!payment) return alert("Completa todos los campos");

  let comprobanteUrl="";
  if(comprobanteFile){
    const data=new FormData();
    data.append("file",comprobanteFile);
    data.append("upload_preset","vendors_preset");
    const res=await fetch(`https://api.cloudinary.com/v1_1/df79cjklp/upload`,{method:"POST",body:data});
    const json=await res.json();
    comprobanteUrl=json.secure_url;
  }

  await db.collection("orders").add({user:auth.currentUser.uid,userEmail:auth.currentUser.email,buyerName:name,phone,whatsapp,address,email,payment,comprobante:comprobanteUrl,products:cart,status:"pendiente"});
  cart=[]; localStorage.setItem("cart","[]"); renderCart(); showModalMessage("Compra enviada"); closeModal();
}

// --- Historial ---
function loadUserOrders(){
  const history=document.getElementById("purchaseHistory");
  db.collection("orders").where("user","==",auth.currentUser.uid).onSnapshot(snapshot=>{
    let html="";
    snapshot.forEach(doc=>{
      const o=doc.data();
      html+=`<div class="order"><strong>Compra #${doc.id}</strong> - Estado: <span class="status-${o.status.replace(/\s/g,'-')}">${o.status}</span><br>
      <button onclick="toggleDetails('${doc.id}')">Ver/ocultar detalles</button>
      <div id="details-${doc.id}" style="display:none; padding:5px 0;">
      Nombre: ${o.buyerName}<br>Tel: ${o.phone}<br>WhatsApp: ${o.whatsapp}<br>Dirección: ${o.address}<br>Email: ${o.email}<br>Pago: ${o.payment==='yappy'?'+507 63892022 Emanuel Cedeño':'EMANUEL CLEMENTE CEDEÑO MORAN - Banco General -  Cuenta de ahorros - 0454966165208'}<br>Productos: ${o.products.map(p=>p.name).join(", ")}<br>${o.comprobante?`Comprobante: <a href="${o.comprobante}" target="_blank">Ver</a>`:'Sin comprobante'}</div></div>`;
    });
    history.innerHTML=html||"<i>No hay compras</i>";
  });
}
function toggleDetails(id){ const el=document.getElementById(`details-${id}`); el.style.display=(el.style.display==="none")?"block":"none"; }

// --- Admin ---
function loadOrders(){
  if(role!=="admin") return;
  const ordersList=document.getElementById("ordersList");
  const stats=document.getElementById("orderStats");
  db.collection("orders").onSnapshot(snapshot=>{
    let html="", counts={"pendiente":0,"revision de pago":0,"pago verificado":0,"en camino":0,"entregado":0,"cancelada":0};
    snapshot.forEach(doc=>{
      const o=doc.data(); counts[o.status] = counts[o.status]+1||1;
      html+=`<div class="order"><strong>Compra #${doc.id}</strong> - Estado: <span class="status-${o.status.replace(/\s/g,'-')}">${o.status}</span><br>
      <button onclick="toggleAdminDetails('${doc.id}')">Ver/ocultar detalles</button>
      <div id="admin-details-${doc.id}" style="display:none; padding:5px 0;">
      Usuario: ${o.userEmail}<br>Nombre: ${o.buyerName}<br>Tel: ${o.phone}<br>WhatsApp: ${o.whatsapp}<br>Dirección: ${o.address}<br>Email: ${o.email}<br>Pago: ${o.payment==='yappy'?'+507 63892022 Emanuel Cedeño':'EMANUEL CLEMENTE CEDEÑO MORAN - Banco General -  Cuenta de ahorros - 0454966165208'}<br>Productos: ${o.products.map(p=>p.name).join(", ")}<br>Comprobante: ${o.comprobante?`<a href="${o.comprobante}" target="_blank">Ver</a>`:'Sin comprobante'}<div class="actions">${(role==="admin" || o.status==="pendiente"||o.status==="revision de pago")?`<button onclick="changeStatus('${doc.id}')">Cambiar Estado</button>`:""}</div></div></div>`;
    });
    ordersList.innerHTML=html||"<i>No hay solicitudes</i>";
    stats.innerHTML=`<div>Pendiente: ${counts["pendiente"]}</div><div>Revisión de pago: ${counts["revision de pago"]}</div><div>Pago verificado: ${counts["pago verificado"]}</div><div>En camino: ${counts["en camino"]}</div><div>Entregado: ${counts["entregado"]}</div><div>Cancelada: ${counts["cancelada"]}</div>`;
  });
}

function toggleAdminDetails(id){ const el=document.getElementById(`admin-details-${id}`); el.style.display=(el.style.display==="none")?"block":"none"; }
function changeStatus(id){ const newStatus=prompt("Nuevo estado: revision de pago, pago verificado, en camino, entregado"); if(!newStatus) return; db.collection("orders").doc(id).update({status:newStatus}).then(()=>showModalMessage("Estado actualizado")); }

// --- Productos admin ---
async function uploadProduct(){
  const name=document.getElementById("name").value.trim();
  const desc=document.getElementById("description").value.trim();
  const price=parseFloat(document.getElementById("price").value);
  const mediaFile=document.getElementById("media").files[0];
  if(!name||!desc||!price) return alert("Completa todos los campos");
  let mediaUrl="";
  if(mediaFile){
    const data=new FormData(); data.append("file",mediaFile); data.append("upload_preset","vendors_preset");
    const res=await fetch(`https://api.cloudinary.com/v1_1/df79cjklp/upload`,{method:"POST",body:data});
    const json=await res.json(); mediaUrl=json.secure_url;
  }
  db.collection("products").add({name,description:desc,price,media:mediaUrl}).then(()=>{ showModalMessage("Producto subido"); document.getElementById("name").value=''; document.getElementById("description").value=''; document.getElementById("price").value=''; document.getElementById("media").value=''; }).catch(e=>alert(e.message));
}
</script>
</body>
</html>
