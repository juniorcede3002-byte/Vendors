<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vendor</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script src="https://cdn.tailwindcss.com"></script>

<style>
.status{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
.en_revision{background:#fde68a}
.pago_confirmado{background:#bbf7d0}
.en_camino{background:#c7d2fe}
.finalizado{background:#e5e7eb}
.cancelada{background:#fecaca}
</style>
</head>

<body class="bg-slate-100">

<div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded max-w-lg w-full relative">
    <button onclick="closeModal()" class="absolute right-3 top-2 text-xl">&times;</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
// FIREBASE
firebase.initializeApp({
  apiKey:"AIzaSyBXYrQwpfcuAili1HvrmDGEWKjj_2j_lzY",
  authDomain:"proyectovendor.firebaseapp.com",
  projectId:"proyectovendor"
});

const auth=firebase.auth();
const db=firebase.firestore();

// MODAL
function openModal(c){modal.style.display="flex";modalBody.innerHTML=c}
function closeModal(){modal.style.display="none"}

// ================= ORDENES =================

function showOrderDetails(id, isAdmin=false){
  db.collection("orders").doc(id).get().then(doc=>{
    const o=doc.data();
    const editable=o.status==="en_revision";

    let products=o.products.map(p=>`<li>${p.name} - $${p.price}</li>`).join("");

    openModal(`
      <h3 class="text-xl font-bold mb-3">Detalle de compra</h3>

      <p><b>Email:</b> ${o.email}</p>
      <p><b>Estado:</b> <span class="status ${o.status}">${o.status}</span></p>
      <p><b>Total:</b> $${o.total}</p>

      <h4 class="font-bold mt-4">Productos</h4>
      <ul class="list-disc ml-5">${products}</ul>

      ${o.cancelReason?`<p class="text-red-600 mt-3"><b>Motivo:</b> ${o.cancelReason}</p>`:""}

      ${editable ? `
        <button onclick="editOrder('${id}')" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded">
          Editar datos
        </button>`:""}

      ${editable && !isAdmin ? `
        <button onclick="cancelUser('${id}')" class="mt-2 text-red-600 underline">
          Cancelar compra
        </button>`:""}
    `);
  });
}

// EDITAR SOLO SI ESTA EN REVISION
function editOrder(id){
  db.collection("orders").doc(id).get().then(doc=>{
    const o=doc.data();
    if(o.status!=="en_revision"){
      alert("No se puede editar esta compra");
      return;
    }

    let productInputs=o.products.map((p,i)=>`
      <input id="p${i}" value="${p.name}" class="border p-1 w-full mb-1">
    `).join("");

    openModal(`
      <h3 class="font-bold mb-2">Editar productos</h3>
      ${productInputs}
      <button onclick="saveEdit('${id}',${o.products.length})" class="bg-black text-white px-4 py-2 mt-3">
        Guardar cambios
      </button>
    `);
  });
}

function saveEdit(id,count){
  let products=[];
  for(let i=0;i<count;i++){
    products.push({name:document.getElementById("p"+i).value,price:0});
  }
  db.collection("orders").doc(id).update({products}).then(closeModal);
}

// ================= CANCELACIONES =================

function cancelUser(id){
  if(confirm("¿Cancelar esta compra?")){
    db.collection("orders").doc(id).update({
      status:"cancelada",
      cancelReason:"Cancelada por el usuario"
    }).then(closeModal);
  }
}

function cancelAdmin(id){
  const r=prompt("Motivo de cancelación");
  if(r){
    db.collection("orders").doc(id).update({
      status:"cancelada",
      cancelReason:r
    });
  }
}

// ================= ADMIN =================

function loadAdminOrders(){
  db.collection("orders").onSnapshot(s=>{
    adminOrders.innerHTML="";
    s.forEach(d=>{
      const o=d.data();
      adminOrders.innerHTML+=`
        <div class="bg-white p-4 rounded shadow">
          <b>${o.email}</b>
          <span class="status ${o.status}">${o.status}</span>

          <div class="mt-2 flex gap-2">
            <button onclick="showOrderDetails('${d.id}',true)" class="underline">Ver detalles</button>

            ${o.status!=="finalizado" && o.status!=="cancelada" ? `
            <select onchange="db.collection('orders').doc('${d.id}').update({status:this.value})">
              <option ${o.status=="en_revision"?"selected":""}>en_revision</option>
              <option ${o.status=="pago_confirmado"?"selected":""}>pago_confirmado</option>
              <option ${o.status=="en_camino"?"selected":""}>en_camino</option>
              <option ${o.status=="finalizado"?"selected":""}>finalizado</option>
            </select>
            <button onclick="cancelAdmin('${d.id}')" class="text-red-600">Cancelar</button>
            `:""}
          </div>
        </div>
      `;
    });
  });
}
</script>

</body>
</html>